<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KRONO DUAL V.2.5 SmartStart</title>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- Firebase (Safe Boilerplate) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        try {
            const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            if (configStr) {
                const firebaseConfig = JSON.parse(configStr);
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                signInAnonymously(auth).catch(console.error);
            }
        } catch (e) {
            console.log("Modo offline/local activo");
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: {
                            100: '#FFF9C4',
                            300: '#FFF176',
                            400: '#FFEE58',
                            500: '#FFD700', // Classic Gold
                            600: '#FFC107',
                            700: '#FFA000',
                            800: '#FF8F00',
                            900: '#B8860B'  // Dark Gold
                        },
                        dark: {
                            900: '#0a0a0a',
                            800: '#111111'
                        }
                    },
                    fontFamily: {
                        arial: ['Arial', 'Helvetica', 'sans-serif'],
                    },
                    boxShadow: {
                        'gold': '0 0 15px rgba(255, 215, 0, 0.3)',
                        'gold-inset': 'inset 0 0 10px rgba(255, 215, 0, 0.1)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Base Gold */
        body {
            background-color: #050505;
            background-image: radial-gradient(circle at 50% 0%, #332a00 0%, #000000 100%);
            color: #FFD700;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none;
            font-family: 'Arial', sans-serif;
        }

        /* Efectos Ne√≥n Gold - RESTAURADOS */
        .neon-text-g { text-shadow: 0 0 10px rgba(255, 215, 0, 0.7); }
        .neon-border-g { box-shadow: 0 0 10px rgba(255, 215, 0, 0.2), inset 0 0 10px rgba(255, 215, 0, 0.1); border-color: #FFD700; }
        
        /* Boton Exportar Neon Extra */
        .btn-neon-export {
            background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
            border: 1px solid #FFD700;
            color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
            font-size: 0.7rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-neon-export:hover {
            background: #FFD700;
            color: #000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            transform: scale(1.02);
        }

        /* Sem√°foro - RESTAURADO */
        .bulb {
            width: 20px; height: 20px; border-radius: 50%;
            background-color: #222; border: 2px solid #554400;
            transition: all 0.1s;
        }
        .bulb.red { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; border-color: #ffaaaa; }
        .bulb.green { background-color: #22c55e; box-shadow: 0 0 15px #22c55e; border-color: #aaffaa; }

        /* ROIs - Dorados y Visibles - RESTAURADO */
        .roi {
            position: absolute; 
            border: 2px dashed #FFD700;
            display: none; 
            cursor: move; 
            z-index: 50; 
            touch-action: none;
            box-sizing: border-box; 
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        
        #roi1 { color: #FFD700; }
        #roi2 { color: #FFA000; border-color: #FFA000; }

        .roi.active { 
            border-style: solid; 
            border-width: 4px; 
            background: rgba(255, 255, 255, 0.4); 
            box-shadow: 0 0 20px #FFD700;
            border-color: #FFF;
        }
        
        .roi-handle {
            position: absolute; bottom: 0; right: 0; width: 30px; height: 30px;
            background: linear-gradient(135deg, transparent 50%, #FFD700 50%);
            cursor: nwse-resize; 
            opacity: 1;
        }

        /* Botones Dorados - RESTAURADO */
        .btn-gold {
            background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
            border: 1px solid #B8860B;
            color: #FFD700;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
        }
        .btn-gold:hover:not(:disabled) {
            background: linear-gradient(180deg, #332a00 0%, #1a1500 100%);
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }
        .btn-gold:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #444;
            color: #666;
        }

        .btn-adj {
            background: #111; color: #FFD700; border: 1px solid #B8860B;
            width: 40px; height: 100%; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; font-weight: bold; cursor: pointer; 
            font-size: 1.25rem;
        }
        .btn-adj:active { background: #FFD700; color: #000; }

        /* Animaciones - RESTAURADO */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .slide-down { animation: slideDown 0.3s ease-out forwards; }
        @keyframes slideDown { from { max-height: 0; opacity: 0; } to { max-height: 800px; opacity: 1; } }
        
        .chart-bar { transition: height 0.3s ease; }
        
        /* Inputs Gold */
        input[type=range] { accent-color: #FFD700; }

        /* Ajustes espec√≠ficos para m√≥viles muy peque√±os */
        @media (max-width: 380px) {
            .btn-gold { font-size: 0.6rem; padding: 0.5rem; }
            h1 { font-size: 1.2rem; }
            .roi-handle { width: 25px; height: 25px; }
            .bulb { width: 15px; height: 15px; }
        }
    </style>
</head>
<body id="app-body" class="flex flex-col min-h-screen p-2 max-w-5xl mx-auto w-full font-arial overflow-x-hidden">

    <!-- ERROR HANDLER -->
    <div id="err" class="hidden bg-red-900/80 border border-red-500 text-white p-2 text-center text-sm rounded mb-2 z-50 fixed top-0 left-0 w-full"></div>
    <script>window.onerror=function(m){const e=document.getElementById('err');e.classList.remove('hidden');e.innerHTML='ERROR: '+m; setTimeout(()=>e.classList.add('hidden'), 5000);}</script>

    <!-- HEADER -->
    <header class="bg-black/60 backdrop-blur-xl border border-gold-900 rounded-xl p-3 shadow-gold flex flex-wrap justify-between items-center gap-3 mb-4 sticky top-0 z-40 transition-all">
        <div class="flex flex-col min-w-max">
            <h1 class="text-xl sm:text-2xl font-black italic tracking-tighter leading-none text-white">
                KRONODUAL <span class="text-gold-500 neon-text-g">V.2.5</span>
            </h1>
            <span class="text-[9px] sm:text-[10px] font-bold text-gold-700 tracking-widest uppercase">By Albert Closa</span>
        </div>

        <div class="flex gap-2 flex-wrap sm:flex-nowrap justify-end flex-1">
            <button onclick="toggleConfig()" class="btn-gold text-[10px] py-2 px-3 sm:px-4 rounded-full flex items-center justify-center gap-2 whitespace-nowrap font-black tracking-wider">
                AJUSTES
            </button>
            <button onclick="showRecords()" class="btn-gold text-[10px] py-2 px-3 sm:px-4 rounded-full flex items-center justify-center gap-2 whitespace-nowrap font-black tracking-wider">
                HISTORIAL
            </button>
            <button onclick="toggleFullScreen()" class="btn-gold text-[10px] w-8 h-8 rounded-full flex items-center justify-center p-0 shrink-0" title="Pantalla Completa">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
            </button>
        </div>

        <!-- Sem√°foro con flex-wrap control -->
        <div class="bg-black p-2 rounded-full border border-gold-900 flex gap-2 shadow-inner shrink-0 scale-90 sm:scale-100 origin-right">
            <div id="l1" class="bulb"></div><div id="l2" class="bulb"></div><div id="l3" class="bulb"></div><div id="l4" class="bulb"></div><div id="l5" class="bulb"></div>
        </div>
    </header>

    <!-- PANEL DE AJUSTES: grid-cols-2 siempre + min-w-0 para evitar desborde -->
    <div id="config" class="hidden w-full bg-dark-900/90 backdrop-blur-xl border-x border-b border-gold-900 rounded-b-xl p-4 mb-4 shadow-2xl relative z-30 max-h-[80vh] overflow-y-auto">
        <div class="grid grid-cols-2 gap-3 sm:gap-6 mb-4">
            <!-- COLUMNA P1 -->
            <div class="bg-yellow-900/10 p-2 sm:p-3 rounded-lg border border-yellow-700/30 min-w-0">
                <label class="text-xs font-bold text-gold-400 mb-1 block">PILOTO 1 (ORO)</label>
                <input id="in-p1-n" value="Piloto 1" onchange="updUI()" class="w-full bg-black border border-gold-900 rounded p-2 sm:p-3 text-sm text-gold-100 mb-2 focus:border-gold-500 outline-none placeholder-gray-600">
                <input id="in-p1-c" value="Golden Bull" onchange="updUI()" class="w-full bg-black border border-gold-900 rounded p-2 sm:p-3 text-xs text-gold-600 mb-3 focus:border-gold-500 outline-none placeholder-gray-600">
                
                <label class="text-[10px] font-bold text-gold-700 uppercase">Tono P1</label>
                <select id="snd-p1" onchange="previewTone(this.value)" class="w-full bg-black border border-gold-900 rounded p-2 sm:p-3 text-sm mb-3 text-gold-300">
                    <option value="C5">Tono Alto (C5)</option>
                    <option value="A4">Tono Medio (A4)</option>
                    <option value="F4">Tono Bajo (F4)</option>
                    <option value="E6">Digital (E6)</option>
                </select>

                <label class="text-[10px] font-bold text-gold-700 uppercase flex justify-between">
                    <span>Umbral P1</span> <span id="lbl-sens-p1" class="text-gold-400 font-bold text-lg">100</span>
                </label>
                <div class="flex items-center gap-2 sm:gap-3 mt-2 h-8">
                    <button class="btn-adj touch-manipulation" onclick="adjSens(1, -5)">-</button>
                    <input type="range" id="in-sens-p1" min="0" max="255" value="100" oninput="updSensUI(1)" class="flex-1 h-full bg-dark-800 rounded-lg appearance-none cursor-pointer mx-1 sm:mx-2">
                    <button class="btn-adj touch-manipulation" onclick="adjSens(1, 5)">+</button>
                </div>
            </div>

            <!-- COLUMNA P2 -->
            <div class="bg-orange-900/10 p-2 sm:p-3 rounded-lg border border-orange-900/30 min-w-0">
                <label class="text-xs font-bold text-orange-400 mb-1 block">PILOTO 2 (BRONCE)</label>
                <input id="in-p2-n" value="Piloto 2" onchange="updUI()" class="w-full bg-black border border-orange-900 rounded p-2 sm:p-3 text-sm text-gold-100 mb-2 focus:border-orange-500 outline-none placeholder-gray-600">
                <input id="in-p2-c" value="Bronze Horse" onchange="updUI()" class="w-full bg-black border border-orange-900 rounded p-2 sm:p-3 text-xs text-orange-600 mb-3 focus:border-orange-500 outline-none placeholder-gray-600">
                
                <label class="text-[10px] font-bold text-orange-700 uppercase">Tono P2</label>
                <select id="snd-p2" onchange="previewTone(this.value)" class="w-full bg-black border border-orange-900 rounded p-2 sm:p-3 text-sm mb-3 text-gold-300">
                    <option value="F4">Tono Bajo (F4)</option>
                    <option value="A4">Tono Medio (A4)</option>
                    <option value="C5">Tono Alto (C5)</option>
                    <option value="C3">Grave (C3)</option>
                </select>

                <label class="text-[10px] font-bold text-orange-700 uppercase flex justify-between">
                    <span>Umbral P2</span> <span id="lbl-sens-p2" class="text-orange-400 font-bold text-lg">100</span>
                </label>
                <div class="flex items-center gap-2 sm:gap-3 mt-2 h-8">
                    <button class="btn-adj border-orange-900 text-orange-400 touch-manipulation" onclick="adjSens(2, -5)">-</button>
                    <input type="range" id="in-sens-p2" min="0" max="255" value="100" oninput="updSensUI(2)" class="flex-1 h-full bg-dark-800 rounded-lg appearance-none cursor-pointer accent-orange-500 mx-1 sm:mx-2">
                    <button class="btn-adj border-orange-900 text-orange-400 touch-manipulation" onclick="adjSens(2, 5)">+</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 border-t border-gold-900/50 pt-4">
            <div class="w-full">
                <label class="text-xs font-bold text-gold-700 mb-1 block">VUELTAS DE CARRERA</label>
                <select id="in-laps" onchange="updUI()" class="w-full bg-black border border-gold-900 rounded p-3 text-sm text-gold-300">
                    <option value="5">5 Vueltas (Sprint)</option>
                    <option value="10" selected>10 Vueltas (Standard)</option>
                    <option value="20">20 Vueltas (Long)</option>
                    <option value="50">50 Vueltas (Endurance)</option>
                    <option value="9999">Pr√°ctica Libre (‚àû)</option>
                </select>
            </div>
            <div class="w-full flex items-center justify-center pt-4 sm:pt-6">
                <label class="flex items-center cursor-pointer gap-3 p-2 rounded hover:bg-white/5 w-full justify-center">
                    <input type="checkbox" id="voice-chk" checked class="w-6 h-6 accent-gold-500 rounded bg-black border-gold-700">
                    <span class="text-sm font-bold text-gold-500">LOCUTOR (TTS) ACTIVO</span>
                </label>
            </div>
        </div>
    </div>

    <!-- MAIN TIMER -->
    <div class="relative bg-gradient-to-br from-dark-900 to-black border border-gold-900 rounded-2xl p-4 sm:p-6 text-center shadow-[0_0_20px_rgba(184,134,11,0.2)] mb-4 overflow-hidden">
        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJub25lIiBzdHJva2U9InJnYmEoMjU1LDIxNSwwLDAuMDUpIj48cGF0aCBkPSJNMCAwaDIwdjIwSDB6Ii8+PC9zdmc+')] opacity-20"></div>
        <div class="relative z-10">
            <div class="text-[9px] sm:text-[10px] font-bold text-gold-600 tracking-[0.3em] uppercase mb-1">Tiempo de Carrera</div>
            <div id="main-timer" class="text-5xl sm:text-7xl font-black text-white tabular-nums tracking-tight drop-shadow-[0_0_10px_rgba(255,215,0,0.3)] font-arial">
                00:00.00
            </div>
            <div id="lap-counter" class="text-[10px] sm:text-xs font-bold text-yellow-400 tracking-[0.2em] uppercase mt-2">
                PREPARADO
            </div>
        </div>
    </div>

    <!-- VIDEO ZONE -->
    <div class="bg-dark-900 border border-gold-900 rounded-xl p-3 sm:p-4 shadow-lg mb-4">
        <div class="flex flex-wrap justify-between items-center mb-3 gap-2">
            <div class="flex gap-2 w-full sm:w-auto">
                <button id="btn-cam" onclick="toggleCam()" class="flex-1 sm:flex-none btn-gold text-[10px] py-3 px-4 rounded-full shadow-none border-gold-800 text-gold-500 font-bold">
                    ENCENDER C√ÅMARA
                </button>
                <button id="btn-auto" onclick="autoCalibrate()" class="hidden flex-1 sm:flex-none btn-gold text-[10px] py-3 px-4 rounded-full shadow-none border-gold-600 text-gold-200 bg-gradient-to-r from-yellow-900 to-black animate-pulse">
                    üéØ AUTO-AJUSTE
                </button>
            </div>
            <div class="flex gap-2 text-[10px] font-bold bg-black/50 px-3 py-2 rounded-full border border-gold-900 font-arial items-center w-full sm:w-auto justify-center">
                <div class="flex flex-col items-center flex-1 sm:flex-none">
                    <span class="text-gold-400">P1: <b id="val-p1">0</b></span>
                    <span id="st-p1" class="text-[8px] uppercase font-black text-gray-500">--</span>
                </div>
                <span class="text-gold-800 mx-1">|</span>
                <div class="flex flex-col items-center flex-1 sm:flex-none">
                    <span class="text-orange-400">P2: <b id="val-p2">0</b></span>
                    <span id="st-p2" class="text-[8px] uppercase font-black text-gray-500">--</span>
                </div>
            </div>
        </div>

        <!-- VIDEO CONTAINER -->
        <div class="relative w-full h-[30vh] min-h-[240px] max-h-[60vh] bg-black rounded-lg overflow-hidden border-2 border-gold-900 shadow-inner group">
            <div id="cam-msg" class="absolute inset-0 flex flex-col items-center justify-center text-gold-800 pointer-events-none">
                <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                <p class="text-xs font-bold">C√ÅMARA APAGADA</p>
            </div>
            <video id="webcam" class="w-full h-full object-cover hidden" autoplay playsinline muted></video>
            
            <!-- OVERLAY RECORD -->
            <div id="record-overlay" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/90 border-2 border-gold-500 p-6 rounded-xl text-center opacity-0 pointer-events-none transition-all transform scale-90 z-50 shadow-[0_0_50px_rgba(255,215,0,0.5)] w-[80%]">
                <div class="text-gold-400 text-lg sm:text-2xl font-black uppercase mb-1 font-arial">¬°NUEVO R√âCORD!</div>
                <div id="rec-data" class="text-white text-lg sm:text-xl font-bold font-arial tracking-widest break-words">--.---</div>
            </div>

            <!-- ROIS -->
            <div id="roi1" class="roi" style="top: 30%; left: 20%; width: 15%; height: 20%;">
                <div class="absolute -top-6 left-0 bg-gold-500 text-black text-[10px] font-bold px-2 rounded-sm border border-white">P1</div>
                <div class="roi-handle touch-manipulation"></div>
            </div>
            <div id="roi2" class="roi" style="top: 30%; left: 60%; width: 15%; height: 20%;">
                <div class="absolute -top-6 left-0 bg-orange-600 text-black text-[10px] font-bold px-2 rounded-sm border border-white">P2</div>
                <div class="roi-handle touch-manipulation"></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4">
            <button id="btn-start" onclick="toggleRace()" disabled class="btn-gold py-4 px-4 rounded-xl text-sm shadow-md disabled:opacity-50 touch-manipulation font-black">
                INICIAR
            </button>
            <button id="btn-reset" onclick="resetRace()" disabled class="bg-dark-800 text-red-500 font-black py-4 px-4 rounded-xl text-sm transition-all border border-red-900/30 shadow-md hover:bg-red-900/10 disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation">
                RESET
            </button>
        </div>
    </div>

    <!-- TELEMETRY CARDS -->
    <div class="bg-dark-900/80 backdrop-blur-lg border border-gold-900 rounded-xl p-3 sm:p-4 shadow-lg mb-4">
        <h3 class="text-left text-xs font-bold text-gold-500 tracking-[0.2em] uppercase border-b border-gold-900 pb-2 mb-4 neon-text-g pl-1">Telemetr√≠a en Vivo</h3>
        
        <!-- CAMBIO: grid-cols-2 siempre + min-w-0 en hijos para evitar overflow -->
        <div class="grid grid-cols-2 gap-2 sm:gap-4"> 
            <!-- P1 CARD -->
            <div class="bg-gradient-to-b from-dark-800 to-black border-l-4 border-gold-500 p-3 rounded shadow-lg relative overflow-hidden min-w-0">
                <div class="absolute top-0 right-0 p-1 opacity-10"><h1 class="text-4xl font-black text-gold-500">1</h1></div>
                <h3 class="text-lg font-black text-gold-400 leading-none truncate" id="disp-p1-n">P1</h3>
                <span class="text-[9px] font-bold text-gold-700 uppercase tracking-wider block mb-3 truncate" id="disp-p1-c">CAR 1</span>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-dark-800/50 p-1 rounded border border-gold-900/30"><span class="text-[7px] sm:text-[8px] text-gold-600 block font-bold">VUELTAS</span><span id="disp-p1-l" class="text-sm font-bold text-white font-arial">0</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-gold-900/30"><span class="text-[7px] sm:text-[8px] text-gold-600 block font-bold">TOTAL</span><span id="disp-p1-tot" class="text-sm font-bold text-white font-arial">00:00</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-gold-900/30"><span class="text-[7px] sm:text-[8px] text-gold-600 block font-bold">VELOCIDAD</span><span id="disp-p1-spd" class="text-[10px] sm:text-xs font-bold text-white font-arial">0</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-gold-900/30"><span class="text-[7px] sm:text-[8px] text-gold-600 block font-bold">√öLTIMA</span><span id="disp-p1-last" class="text-[10px] sm:text-xs font-bold text-white font-arial">--.--</span></div>
                    <div class="col-span-2 bg-yellow-900/20 border border-gold-500/30 p-2 rounded text-center">
                        <span class="text-[8px] text-gold-200 block font-bold uppercase tracking-widest">MEJOR TIEMPO</span>
                        <span id="disp-p1-best" class="text-xl font-black text-white font-arial drop-shadow-[0_0_5px_rgba(255,215,0,0.5)]">--.--</span>
                    </div>
                </div>
            </div>

            <!-- P2 CARD -->
            <div class="bg-gradient-to-b from-dark-800 to-black border-l-4 border-orange-600 p-3 rounded shadow-lg relative overflow-hidden min-w-0">
                <div class="absolute top-0 right-0 p-1 opacity-10"><h1 class="text-4xl font-black text-orange-600">2</h1></div>
                <h3 class="text-lg font-black text-orange-500 leading-none truncate" id="disp-p2-n">P2</h3>
                <span class="text-[9px] font-bold text-orange-800 uppercase tracking-wider block mb-3 truncate" id="disp-p2-c">CAR 2</span>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-dark-800/50 p-1 rounded border border-orange-900/30"><span class="text-[7px] sm:text-[8px] text-orange-700 block font-bold">VUELTAS</span><span id="disp-p2-l" class="text-sm font-bold text-white font-arial">0</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-orange-900/30"><span class="text-[7px] sm:text-[8px] text-orange-700 block font-bold">TOTAL</span><span id="disp-p2-tot" class="text-sm font-bold text-white font-arial">00:00</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-orange-900/30"><span class="text-[7px] sm:text-[8px] text-orange-700 block font-bold">VELOCIDAD</span><span id="disp-p2-spd" class="text-[10px] sm:text-xs font-bold text-white font-arial">0</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-orange-900/30"><span class="text-[7px] sm:text-[8px] text-orange-700 block font-bold">√öLTIMA</span><span id="disp-p2-last" class="text-[10px] sm:text-xs font-bold text-white font-arial">--.--</span></div>
                    <div class="col-span-2 bg-orange-900/20 border border-orange-600/30 p-2 rounded text-center">
                        <span class="text-[8px] text-orange-200 block font-bold uppercase tracking-widest">MEJOR TIEMPO</span>
                        <span id="disp-p2-best" class="text-xl font-black text-white font-arial drop-shadow-[0_0_5px_rgba(255,100,0,0.5)]">--.--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6">
            <h4 class="text-xs font-bold text-gold-500 mb-2 uppercase neon-text-g text-left pl-1">Ritmo de Carrera</h4>
            <div class="bg-dark-800/50 border border-gold-900/50 h-40 sm:h-56 rounded relative p-2 pl-8">
                <div class="absolute left-1 top-2 bottom-2 flex flex-col justify-between text-[8px] text-gold-700 font-bold">
                    <span id="chart-max">10s</span>
                    <span id="chart-mid">5s</span>
                    <span>0s</span>
                </div>
                <svg id="chart-svg" class="w-full h-full overflow-visible" preserveAspectRatio="none">
                    <!-- Lines and bars dynamically injected -->
                </svg>
            </div>
        </div>
    </div>

    <!-- MODAL RESULTADOS -->
    <div id="res-modal" class="fixed inset-0 bg-black/80 backdrop-blur-xl z-50 hidden flex items-center justify-center fade-in">
        <div class="bg-dark-900/90 border border-gold-600 w-[95%] max-w-lg max-h-[90vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden slide-down">
            <div class="bg-gradient-to-b from-dark-800 to-black p-6 text-center border-b border-gold-800">
                <div class="text-4xl mb-2">üèÜ</div>
                <div class="text-[10px] font-bold text-gold-500 tracking-widest uppercase mb-1">VICTORIA</div>
                <h1 class="text-3xl font-black text-white uppercase leading-none mb-1 neon-text-g" id="res-winner">NOMBRE</h1>
                <span class="text-xs font-bold text-gold-700 uppercase tracking-widest" id="res-car">COCHE</span>
                
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <div class="bg-yellow-900/20 border border-gold-600/30 p-2 rounded col-span-2">
                        <span class="text-[10px] text-gold-500 font-bold block">TIEMPO TOTAL</span>
                        <span class="text-xl font-arial font-bold text-yellow-400" id="res-total">--:--</span>
                    </div>
                    <div class="bg-dark-800 p-2 rounded border border-gold-900/30">
                        <span class="text-[10px] text-gray-500 font-bold block">MEJOR VUELTA</span>
                        <span class="text-lg font-arial font-bold text-gold-400" id="res-best">--.--</span>
                    </div>
                    <div class="bg-dark-800 p-2 rounded border border-gold-900/30">
                        <span class="text-[10px] text-gray-500 font-bold block">VEL. MEDIA</span>
                        <span class="text-lg font-bold text-white" id="res-spd-avg">0</span>
                    </div>
                    <div class="bg-dark-800 p-2 rounded border border-gold-900/30">
                        <span class="text-[10px] text-gray-500 font-bold block">TIEMPO MEDIO</span>
                        <span class="text-lg font-arial font-bold text-white" id="res-avg">--.--</span>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <h4 class="text-xs font-bold text-gold-400 border-b border-gold-900 pb-1 mb-2">P1 TIEMPOS</h4>
                        <table class="w-full text-xs text-gray-400">
                            <tbody id="tb-p1" class="divide-y divide-gray-800"></tbody>
                        </table>
                    </div>
                    <div class="w-1/2">
                        <h4 class="text-xs font-bold text-orange-600 border-b border-orange-900 pb-1 mb-2">P2 TIEMPOS</h4>
                        <table class="w-full text-xs text-gray-400">
                            <tbody id="tb-p2" class="divide-y divide-gray-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-black border-t border-gold-900 flex flex-col gap-3">
                <div class="flex gap-3 w-full">
                    <button onclick="closeModal('res-modal')" class="flex-1 bg-dark-800 hover:bg-dark-700 text-white font-bold py-3 rounded-lg text-xs transition-all border border-gray-700">CERRAR</button>
                    <button onclick="newRace()" class="flex-1 btn-gold py-3 rounded-lg text-xs transition-all shadow-lg uppercase">NUEVA CARRERA</button>
                </div>
                <!-- EXPORTAR EXCEL MOVIDO AQUI -->
                <button onclick="exportToExcel()" class="btn-neon-export w-full py-2 rounded-lg flex items-center justify-center gap-2 transform hover:bg-gold-900/20 border-gold-900 text-gold-600 hover:text-gold-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Descargar Excel
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL RECORDS -->
    <div id="rec-modal" class="fixed inset-0 bg-black/80 backdrop-blur-xl z-50 hidden flex items-center justify-center fade-in">
        <div class="bg-dark-900/90 border border-gold-600/50 w-[95%] max-w-5xl max-h-[90vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden slide-down relative">
            <div class="bg-gradient-to-r from-black via-yellow-900/20 to-black p-6 text-center border-b border-gold-600/30">
                <div class="text-3xl mb-2">üëë</div>
                <h1 class="text-2xl font-black text-gold-500 uppercase tracking-widest neon-text-g">Hall of Fame</h1>
            </div>
            
            <div class="flex-1 overflow-y-auto p-0">
                <table class="w-full text-[10px] sm:text-xs text-left whitespace-nowrap">
                    <thead class="bg-slate-950 text-slate-400 sticky top-0">
                        <tr>
                            <th class="p-3 font-bold">FECHA</th>
                            <th class="p-3 font-bold text-cyan-400">PILOTO</th>
                            <th class="p-3 font-bold">COCHE</th>
                            <th class="p-3 font-bold text-yellow-400 text-right font-arial">TOTAL</th>
                            <th class="p-3 font-bold text-green-400 text-right font-arial">MEJOR</th>
                            <th class="p-3 font-bold text-blue-400 text-right font-arial">MEDIA</th>
                            <th class="p-3 font-bold text-right font-arial">VEL.</th>
                        </tr>
                    </thead>
                    <tbody id="records-list" class="divide-y divide-slate-800 text-slate-300"></tbody>
                </table>
            </div>

            <div class="p-3 bg-slate-950 border-t border-slate-800 flex justify-between items-center">
                <button onclick="closeModal('rec-modal')" class="text-yellow-500 text-[10px] font-bold hover:text-white transition-colors tracking-widest px-2 py-1">CERRAR</button>
                <button onclick="tryClearRecords()" class="group flex items-center gap-1.5 px-3 py-1 rounded hover:bg-red-900/20 transition-all" title="Borrar Historial">
                    <span class="text-[9px] text-red-500/70 font-bold uppercase group-hover:text-red-400 transition-colors">Borrar</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500/70 group-hover:text-red-400 group-hover:scale-110 transition-all"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>

            <!-- CONFIRMATION OVERLAY (Updated Design) -->
            <div id="conf-modal" class="absolute inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center fade-in">
                <div class="bg-dark-900 border border-gold-900/50 p-5 rounded-xl shadow-2xl max-w-xs w-[85%] transform scale-100 transition-all ring-1 ring-white/5">
                    <div class="flex flex-col items-center text-center">
                        <div class="text-red-500/80 mb-3 bg-red-900/10 p-2 rounded-full ring-1 ring-red-500/20">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </div>
                        <h3 class="text-gold-500 font-bold uppercase text-xs tracking-widest mb-2">¬øBorrar Historial?</h3>
                        <p class="text-gray-400 text-[10px] mb-5 leading-relaxed">
                            No podr√°s recuperar los registros.<br>¬øConfirmas la eliminaci√≥n?
                        </p>
                        <div class="flex gap-2 w-full">
                            <button onclick="confirmDelete(false)" class="flex-1 bg-transparent border border-gray-700 text-gray-400 hover:text-white hover:border-gray-500 py-2 rounded-lg text-[10px] font-bold uppercase transition-colors">
                                Cancelar
                            </button>
                            <button onclick="confirmDelete(true)" class="flex-1 bg-red-900/20 border border-red-900/40 text-red-500 hover:bg-red-900/40 hover:text-red-400 py-2 rounded-lg text-[10px] font-bold uppercase transition-colors">
                                Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="cv" class="hidden"></canvas>

    <script>
        // --- UTILIDADES ---
        const get = (id) => document.getElementById(id);
        const set = (id, txt) => { const el = get(id); if(el) el.innerText = txt; }
        const fmt = (ms) => (ms/1000).toFixed(2);
        const fmtTime = (ms) => {
            let m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), i=Math.floor((ms%1000)/10);
            return (m<10?'0':'')+m+":"+(s<10?'0':'')+s+"."+(i<10?'0':'')+i;
        };

        // --- ESTADO ---
        const state = {
            race: false, cam: false, start: 0, timer: null,
            countdown: false, aborted: false,
            flags: { f5: false, f1: false },
            p1: { n:'P1', c:'C1', laps:0, best:999999, h:[], last:0, fin:false, blk:false, total:0 },
            p2: { n:'P2', c:'C2', laps:0, best:999999, h:[], last:0, fin:false, blk:false, total:0 },
            cfg: { laps:10 } 
        };

        const vid = get('webcam');
        const cv = get('cv');
        const ctx = cv.getContext('2d', { willReadFrequently: true });

        // --- TONE.JS SETUP ---
        let synth, polySynth;
        
        async function initAudio() {
            if(!synth) {
                await Tone.start();
                synth = new Tone.Synth().toDestination();
                polySynth = new Tone.PolySynth(Tone.Synth).toDestination();
                synth.volume.value = -5;
                polySynth.volume.value = -5;
            }
        }

        function playTone(note) {
            if(synth) synth.triggerAttackRelease(note, "8n");
        }

        function previewTone(note) {
            initAudio().then(() => playTone(note));
        }

        async function playStartSequence() {
            await initAudio();
            // 5 Sem√°foros
            for(let i=1; i<=5; i++) {
                if(state.aborted) return;
                get('l'+i).classList.add('red');
                synth.triggerAttackRelease("C4", "8n"); 
                await new Promise(r => setTimeout(r, 900));
            }
            if(state.aborted) return;
            
            // Random delay
            await new Promise(r => setTimeout(r, Math.random()*1500 + 500));
            if(state.aborted) return;

            // Green Light
            for(let i=1; i<=5; i++) { get('l'+i).classList.remove('red'); get('l'+i).classList.add('green'); }
            // Salida
            polySynth.triggerAttackRelease(["C5", "E5", "G5"], "2n");
            
            startRaceLogic();
        }

        function playFalseStartSound() {
            if(synth) {
                const now = Tone.now();
                synth.triggerAttackRelease("G3", "8n", now);
                synth.triggerAttackRelease("G3", "8n", now + 0.2);
            }
        }

        function playLapSound(id) {
            if(!synth) return;
            const note = get('snd-p'+id).value;
            synth.triggerAttackRelease(note, "16n");
        }

        function playBell() {
            if(!polySynth) return;
            polySynth.triggerAttackRelease(["C6", "E6"], "8n");
        }

        // --- TTS (Voz) CON COLA INTELIGENTE ---
        let msgQueue = [];
        let isSpeaking = false;

        function speak(txt) {
            if(!get('voice-chk').checked) return;
            msgQueue.push(txt);
            processQueue();
        }

        function processQueue() {
            if(isSpeaking || msgQueue.length === 0) return;
            
            isSpeaking = true;
            const txt = msgQueue.shift();
            
            if('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(txt);
                u.rate = 1.1; 
                u.lang = 'es-ES';
                u.onend = () => {
                    isSpeaking = false;
                    processQueue();
                };
                u.onerror = (e) => {
                    console.error("TTS Error", e);
                    isSpeaking = false;
                    processQueue();
                };
                window.speechSynthesis.speak(u);
            } else {
                isSpeaking = false;
            }
        }

        function stopSpeaking() {
            if('speechSynthesis' in window) window.speechSynthesis.cancel();
            msgQueue = [];
            isSpeaking = false;
        }

        // --- PANTALLA COMPLETA ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Error al intentar pantalla completa: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // --- EXPORTAR EXCEL (CSV) ---
        function exportToExcel() {
            const d = new Date();
            const fecha = d.toLocaleDateString();
            const hora = d.toLocaleTimeString();
            
            // Cabecera CSV
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "KRONO DUAL - REPORTE DE CARRERA\n";
            csvContent += `Fecha;${fecha}\nHora;${hora}\n\n`;
            
            // Datos generales
            csvContent += `PILOTO 1 (P1);${state.p1.n};COCHE;${state.p1.c}\n`;
            csvContent += `PILOTO 2 (P2);${state.p2.n};COCHE;${state.p2.c}\n\n`;
            
            // Tabla de Vueltas
            csvContent += "VUELTA;P1 TIEMPO (s);P1 VEL (km/h);P2 TIEMPO (s);P2 VEL (km/h)\n";
            
            const maxLaps = Math.max(state.p1.h.length, state.p2.h.length);
            
            for(let i=0; i<maxLaps; i++) {
                const t1 = state.p1.h[i] ? fmt(state.p1.h[i]) : "-";
                const v1 = state.p1.h[i] ? ((25/(state.p1.h[i]/1000))*3.6).toFixed(1) : "-";
                
                const t2 = state.p2.h[i] ? fmt(state.p2.h[i]) : "-";
                const v2 = state.p2.h[i] ? ((25/(state.p2.h[i]/1000))*3.6).toFixed(1) : "-";
                
                csvContent += `${i+1};${t1.replace('.',',')};${v1.replace('.',',')};${t2.replace('.',',')};${v2.replace('.',',')}\n`;
            }

            // Resumen Final
            csvContent += "\nRESUMEN FINAL\n";
            csvContent += `TIEMPO TOTAL;${fmtTime(state.p1.total)};${fmtTime(state.p2.total)}\n`;
            csvContent += `MEJOR VUELTA;${fmt(state.p1.best).replace('.',',')};${fmt(state.p2.best).replace('.',',')}\n`;

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Carrera_${d.getFullYear()}${d.getMonth()+1}${d.getDate()}_${d.getHours()}${d.getMinutes()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- CALIBRACI√ìN AUTO ---
        function autoCalibrate() {
            if (!state.cam) return;
            
            let msg = "";

            [1, 2].forEach(id => {
                const currentVal = parseInt(get('val-p'+id).innerText) || 0;
                let newVal = Math.floor(currentVal * 0.75);
                
                if (newVal < 10) newVal = 10;
                if (newVal > 240) newVal = 240;

                get('in-sens-p'+id).value = newVal;
                updSensUI(id);
                
                if (currentVal < 30) msg = "¬°Poca luz!";
            });

            if (msg !== "") speak(msg);
            else speak("Calibraci√≥n lista");

            // Feedback visual en bot√≥n
            const btn = get('btn-auto');
            btn.innerHTML = msg ? "‚ö†Ô∏è POCA LUZ" : "‚úÖ OK";
            setTimeout(() => {
                btn.innerHTML = "üéØ AUTO-AJUSTE";
            }, 2000);
        }

        // --- CAMARA ---
        async function toggleCam() {
            const btn = get('btn-cam');
            const btnAuto = get('btn-auto');
            
            if(!state.cam) {
                try {
                    await initAudio(); 
                    let stream;
                    try { 
                        stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'environment' }
                        }); 
                    } catch(e) { 
                        stream = await navigator.mediaDevices.getUserMedia({video:true}); 
                    }
                    
                    vid.srcObject = stream;
                    vid.onloadedmetadata = () => {
                        vid.play();
                        cv.width = 320; cv.height = 240;
                        state.cam = true;
                        vid.classList.remove('hidden');
                        get('cam-msg').classList.add('hidden');
                        get('roi1').style.display='block'; get('roi2').style.display='block';
                        
                        btn.innerText = "APAGAR C√ÅMARA";
                        btn.classList.replace('text-gold-500', 'text-red-500');
                        btn.classList.replace('border-gold-800', 'border-red-900');
                        
                        btnAuto.classList.remove('hidden');
                        get('btn-start').disabled = false;
                        loop();
                    };
                } catch(e) { 
                    alert("Error Cam: "+e); 
                    console.error(e);
                }
            } else {
                if(vid.srcObject) vid.srcObject.getTracks().forEach(t=>t.stop());
                state.cam = false; 
                vid.classList.add('hidden');
                get('cam-msg').classList.remove('hidden');
                get('roi1').style.display='none'; get('roi2').style.display='none';
                
                btn.innerText = "ENCENDER C√ÅMARA";
                btn.classList.replace('text-red-500', 'text-gold-500');
                btn.classList.replace('border-red-900', 'border-gold-800');
                
                btnAuto.classList.add('hidden');
                get('btn-start').disabled = true;
            }
        }

        function loop() {
            if(!state.cam) return;
            ctx.drawImage(vid, 0, 0, cv.width, cv.height);
            check(1); check(2);
            requestAnimationFrame(loop);
        }

        // --- DETECCI√ìN & AJUSTE UMBRAL ---
        function adjSens(id, val) {
            const el = get('in-sens-p'+id);
            let n = parseInt(el.value) + val;
            if(n<0) n=0; if(n>255) n=255;
            el.value = n;
            updSensUI(id);
        }

        function updSensUI(id) {
            const v = get('in-sens-p'+id).value;
            get('lbl-sens-p'+id).innerText = v;
        }

        let frameCount = 0;

        function check(id) {
            const roi = get('roi'+id);
            let l = parseFloat(roi.style.left);
            let t = parseFloat(roi.style.top);
            let w = parseFloat(roi.style.width);
            let h = parseFloat(roi.style.height);

            if (isNaN(l)) l = id === 1 ? 20 : 60; 
            if (isNaN(t)) t = 30;
            if (isNaN(w)) w = 15;
            if (isNaN(h)) h = 20;

            const rx = Math.floor((l/100)*cv.width);
            const ry = Math.floor((t/100)*cv.height);
            const rw = Math.floor((w/100)*cv.width);
            const rh = Math.floor((h/100)*cv.height);
            
            if(rw<=0 || rh<=0) return;
            
            const d = ctx.getImageData(rx, ry, rw, rh).data;
            let s=0, c=0;
            for(let i=0; i<d.length; i+=16) { s+=(d[i]+d[i+1]+d[i+2])/3; c++; }
            const avg = Math.floor(s/c);
            
            set('val-p'+id, avg);
            
            const umbral = parseInt(get('in-sens-p'+id).value);

            if (id === 2) frameCount++; 
            if (frameCount % 15 === 0) {
                const elSt = get('st-p'+id);
                const diff = avg - umbral;

                if (avg < 30) {
                    elSt.innerHTML = "üåë OSCURO";
                    elSt.className = "text-[8px] uppercase font-black text-red-500 animate-pulse";
                } else if (diff < 15) {
                    elSt.innerHTML = "‚ö†Ô∏è ALTO"; 
                    elSt.className = "text-[8px] uppercase font-black text-orange-500";
                } else if (diff > 80) {
                    elSt.innerHTML = "‚ö†Ô∏è BAJO"; 
                    elSt.className = "text-[8px] uppercase font-black text-yellow-600";
                } else {
                    elSt.innerHTML = "‚úÖ OK";
                    elSt.className = "text-[8px] uppercase font-black text-green-500";
                }
            }
            
            if(avg < umbral) {
                roi.classList.add('active');
                if(state.race && !state['p'+id].blk && !state['p'+id].fin) {
                    state['p'+id].blk = true; lap(id);
                } else if(state.countdown && !state['p'+id].blk && !state.aborted) {
                    state['p'+id].blk = true;
                    triggerFalseStart(id);
                }
            } else {
                roi.classList.remove('active');
                state['p'+id].blk = false;
            }
        }

        // --- L√ìGICA DE CARRERA ---
        function toggleRace() {
            const btn = get('btn-start');
            if(state.race) {
                stopRace();
                btn.innerText = "INICIAR";
                btn.classList.remove('text-red-400');
            } else {
                startCountdown();
            }
        }

        async function startCountdown() {
            state.aborted = false;
            state.countdown = true;
            get('config').classList.add('hidden'); 
            get('btn-start').disabled = true;
            get('btn-reset').disabled = true;
            get('btn-auto').classList.add('opacity-50', 'pointer-events-none');
            
            for(let i=1; i<=5; i++) get('l'+i).className = 'bulb';
            
            set('main-timer', "00:00.00");
            set('lap-counter', "PREPARADO");
            
            speak("Pilotos a sus puestos");
            await playStartSequence();
        }

        function startRaceLogic() {
            state.countdown = false;
            state.race = true;
            state.start = Date.now();
            resetData();
            
            state.timer = setInterval(()=>{
                set('main-timer', fmtTime(Date.now()-state.start));
            }, 37);
            
            const btn = get('btn-start');
            btn.disabled = false;
            btn.innerText = "PARAR";
            btn.classList.add('text-red-400');
        }

        function triggerFalseStart(id) {
            state.aborted = true;
            state.countdown = false;
            playFalseStartSound();
            const name = get('in-p'+id+'-n').value;
            set('main-timer', "SALIDA NULA");
            set('lap-counter', "CULPABLE: "+name);
            get('main-timer').style.color = '#ef4444';
            
            for(let i=1; i<=5; i++) { get('l'+i).className = 'bulb red'; }
            
            get('btn-start').disabled = false;
            get('btn-start').innerText = "REINICIAR";
            get('btn-auto').classList.remove('opacity-50', 'pointer-events-none');
            speak("Salida nula de " + name);
        }

        function stopRace() {
            state.race = false;
            clearInterval(state.timer);
            get('btn-reset').disabled = false;
            get('btn-auto').classList.remove('opacity-50', 'pointer-events-none');
        }

        function resetRace() {
            stopRace();
            stopSpeaking(); // CALLAR LOCUTOR AL RESETEAR
            set('main-timer', "00:00.00");
            get('main-timer').style.color = 'white';
            set('lap-counter', "PREPARADO");
            for(let i=1; i<=5; i++) get('l'+i).className = 'bulb';
            
            const btn = get('btn-start');
            btn.innerText = "INICIAR";
            btn.classList.remove('text-red-400');
            resetData();
        }

        function lap(id) {
            const now = Date.now();
            const t = now - state['p'+id].last;
            const absT = now - state.start; // Tiempo absoluto desde el sem√°foro verde

            // --- L√ìGICA "PASO 0" (SMART START) ---
            if (state['p'+id].laps === 0 && absT < 3000) {
                const elLast = get('disp-p'+id+'-last');
                if(elLast && elLast.innerText !== "SALIDA") {
                    elLast.innerText = "SALIDA";
                    elLast.classList.add('text-green-500', 'animate-pulse');
                    setTimeout(() => {
                         if(elLast.innerText === "SALIDA") {
                             elLast.innerText = "--.--";
                             elLast.classList.remove('text-green-500', 'animate-pulse');
                         }
                    }, 1500);
                }
                return;
            }

            // Min Lap Time Security (Anti-doble rebote): 2 segundos m√≠nimo entre vueltas
            if(t < 2000) return; 
            
            state['p'+id].last = now;
            state['p'+id].laps++;
            state['p'+id].h.push(t);
            
            playLapSound(id);

            // Record VUELTA R√ÅPIDA
            if(t < state['p'+id].best) {
                state['p'+id].best = t;
                const name = get(`in-p${id}-n`).value;
                speak(`R√©cord ${name}, ${fmt(t)}`);
                showOverlay(`${name} - ${fmt(t)}`);
            }

            updUI(); drawChart();

            // Finish logic
            const max = parseInt(get('in-laps').value);
            if(max !== 9999) {
                const rem = max - state['p'+id].laps;
                if(rem === 5 && !state.flags.f5) {
                    state.flags.f5 = true;
                    speak("Quedan 5 vueltas");
                }
                if(rem === 1 && !state.flags.f1) {
                    state.flags.f1 = true;
                    playBell();
                    speak("√öltima vuelta");
                }
                if(state['p'+id].laps >= max) {
                    finish(id, now);
                }
            }
        }

        function finish(id, now) {
            state['p'+id].fin = true;
            state['p'+id].total = now - state.start;
            
            const p = state['p'+id];
            // Calculos
            const totalTime = p.total;
            const bestLap = p.best < 999999 ? p.best : 0;
            const avgTime = p.h.length ? (p.total / p.h.length) : 0;
            const totalDistMeters = p.laps * 25; 
            const avgSpeed = totalTime > 0 ? (totalDistMeters / (totalTime/1000)) * 3.6 : 0;

            saveRecord(p.n, p.c, totalTime, bestLap, avgTime, avgSpeed);

            const oid = id===1?2:1;
            if(!state['p'+oid].fin) {
                stopRace();
                const name = get(`in-p${id}-n`).value;
                speak(`Victoria para ${name}`);
                showRes(id);
            }
        }

        function showOverlay(txt) {
            const ov = get('record-overlay');
            get('rec-data').innerText = txt;
            ov.classList.replace('opacity-0', 'opacity-100');
            ov.classList.replace('scale-90', 'scale-100');
            setTimeout(()=>{
                ov.classList.replace('opacity-100', 'opacity-0');
                ov.classList.replace('scale-100', 'scale-90');
            }, 2500);
        }

        // --- UI UPDATES ---
        function updUI() {
            const max = get('in-laps').value;
            [1,2].forEach(id=>{
                const p = state['p'+id];
                p.n = get('in-p'+id+'-n').value;
                p.c = get('in-p'+id+'-c').value;
                
                set('disp-p'+id+'-n', p.n);
                set('disp-p'+id+'-c', p.c);
                set('disp-p'+id+'-l', p.laps);
                
                const last = p.h.length ? p.h[p.h.length-1] : 0;
                if(last) set('disp-p'+id+'-last', fmt(last));
                else if(get('disp-p'+id+'-last').innerText !== "SALIDA") set('disp-p'+id+'-last', "--.--");
                
                set('disp-p'+id+'-best', p.best<999999 ? fmt(p.best) : "--.--");
                
                const tot = p.h.reduce((a,b)=>a+b,0);
                set('disp-p'+id+'-tot', tot ? fmtTime(tot) : "00:00");
                
                const spd = last ? ((25/(last/1000))*3.6).toFixed(1) : 0;
                set('disp-p'+id+'-spd', spd+" km/h");
            });
            
            const lead = Math.max(state.p1.laps, state.p2.laps);
            set('lap-counter', `VUELTA ${lead} / ${max==='9999'?'‚àû':max}`);
        }

        // --- GRAFICA (GOLD) ---
        function drawChart() {
            const svg = get('chart-svg');
            svg.innerHTML = `
                <line x1="0" y1="25%" x2="100%" y2="25%" stroke="rgba(255,215,0,0.1)" stroke-width="1"></line>
                <line x1="0" y1="50%" x2="100%" y2="50%" stroke="rgba(255,215,0,0.1)" stroke-width="1"></line>
                <line x1="0" y1="75%" x2="100%" y2="75%" stroke="rgba(255,215,0,0.1)" stroke-width="1"></line>
            `;
            
            const h1 = state.p1.h, h2 = state.p2.h;
            const len = Math.max(h1.length, h2.length);
            if(len === 0) return;
            
            const maxT = Math.max(...h1, ...h2, 5000); 
            
            set('chart-max', (maxT/1000).toFixed(1)+'s');
            set('chart-mid', (maxT/2000).toFixed(1)+'s');
            
            const w = 100/len;
            
            for(let i=0; i<len; i++) {
                const x = i * w;
                if(h1[i]) {
                    const h = (h1[i]/maxT)*100;
                    const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    r.setAttribute("x", x+"%"); r.setAttribute("y", (100-h)+"%");
                    r.setAttribute("width", (w/2.2)+"%"); r.setAttribute("height", h+"%");
                    r.setAttribute("fill", "#FFD700"); r.setAttribute("rx", "2");
                    r.classList.add('chart-bar');
                    svg.appendChild(r);
                }
                if(h2[i]) {
                    const h = (h2[i]/maxT)*100;
                    const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    r.setAttribute("x", (x + w/2)+"%"); r.setAttribute("y", (100-h)+"%");
                    r.setAttribute("width", (w/2.2)+"%"); r.setAttribute("height", h+"%");
                    r.setAttribute("fill", "#B8860B"); r.setAttribute("rx", "2");
                    r.classList.add('chart-bar');
                    svg.appendChild(r);
                }
            }
        }

        // --- RECORDS LOCALSTORAGE ---
        function saveRecord(name, car, total, best, avg, speed) {
            let recs = [];
            try {
                recs = JSON.parse(localStorage.getItem('krono_dual_v2') || '[]');
            } catch(e) { recs = []; }
            
            const date = new Date().toLocaleDateString();
            const hour = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            recs.push({ name, car, total, best, avg, speed, date, hour });
            recs.sort((a,b) => 0); // Mantener orden de inserci√≥n
            
            if (recs.length > 50) recs.shift(); 
            localStorage.setItem('krono_dual_v2', JSON.stringify(recs));
        }

        function showRecords() {
            const tb = get('records-list');
            tb.innerHTML = '';
            let recs = [];
            try {
                recs = JSON.parse(localStorage.getItem('krono_dual_v2') || '[]');
            } catch(e) { recs = []; }
            
            if(recs.length===0) {
                tb.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-500">Sin registros</td></tr>';
            } else {
                [...recs].reverse().forEach(r => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 hover:bg-gray-800/50";
                    tr.innerHTML = `
                        <td class="p-3 text-gold-300">${r.date} <span class="text-[8px] opacity-50 block">${r.hour}</span></td>
                        <td class="p-3 text-cyan-400 font-bold">${r.name}</td>
                        <td class="p-3 text-gray-400">${r.car}</td>
                        <td class="p-3 text-right text-yellow-400 font-bold font-arial">${fmtTime(r.total || 0)}</td>
                        <td class="p-3 text-right text-green-400 font-arial">${fmt(r.best || 0)}</td>
                        <td class="p-3 text-right text-blue-400 font-arial">${fmt(r.avg || 0)}</td>
                        <td class="p-3 text-right text-gray-500 font-arial">${(r.speed || 0).toFixed(1)}</td>
                    `;
                    tb.appendChild(tr);
                });
            }
            get('rec-modal').classList.remove('hidden');
        }

        // --- BORRAR HISTORIAL CON CONFIRMACI√ìN ---
        function tryClearRecords() {
            get('conf-modal').classList.remove('hidden');
        }

        function confirmDelete(yes) {
            if(yes) {
                try {
                    localStorage.removeItem('krono_dual_v2');
                } catch(e) { console.error(e); }
                showRecords();
            }
            get('conf-modal').classList.add('hidden');
        }
        
        // --- MODALES & UTIL ---
        function toggleConfig() { get('config').classList.toggle('hidden'); }
        function closeModal(id) { 
            get(id).classList.add('hidden'); 
            if(id === 'rec-modal') {
                 get('conf-modal').classList.add('hidden');
            }
        }
        function newRace() { closeModal('res-modal'); resetRace(); }
        
        function showRes(wid) {
            const w = state['p'+wid];
            set('res-winner', w.n); set('res-car', w.c);
            set('res-total', fmtTime(w.total));
            set('res-best', fmt(w.best));
            
            const avg = w.h.length ? (w.total/w.h.length) : 0;
            const elAvg = get('res-avg');
            if(elAvg) elAvg.innerText = fmt(avg);

            const avgS = w.total ? ((w.laps*25)/(w.total/1000)*3.6).toFixed(1) : 0;
            set('res-spd-avg', avgS+" km/h");
            
            [1,2].forEach(id=>{
                const tb = get('tb-p'+id); tb.innerHTML='';
                state['p'+id].h.forEach((t,i)=>{
                    const best = t===state['p'+id].best;
                    tb.innerHTML += `<tr class="${best?'bg-yellow-900/40 font-bold text-white':''}">
                        <td class="p-2 border-b border-gray-800 font-arial">${i+1}</td>
                        <td class="p-2 border-b border-gray-800 text-right font-arial">${fmt(t)}</td>
                    </tr>`;
                });
            });
            get('res-modal').classList.remove('hidden');
        }
        
        function resetData() {
            [1,2].forEach(id=>{
                state['p'+id].laps=0; state['p'+id].h=[]; state['p'+id].best=999999;
                state['p'+id].last=state.start; state['p'+id].fin=false; state['p'+id].blk=false;
                state['p'+id].total=0;
            });
            state.flags = {f5:false, f1:false};
            updUI(); drawChart();
        }

        // --- DRAG LOGIC ---
        function setupDrag(id) {
            const el = get(id);
            const h = el.querySelector('.roi-handle');
            let m=null, s={};
            
            const down = (e) => {
                if(state.race) return;
                e.preventDefault();
                el.setPointerCapture(e.pointerId);
                m = (e.target === h) ? 'size' : 'move';
                const r = el.getBoundingClientRect();
                const p = el.parentElement.getBoundingClientRect();
                s = {
                    x: e.clientX, y: e.clientY,
                    l: (el.offsetLeft/p.width)*100, t: (el.offsetTop/p.height)*100,
                    w: (r.width/p.width)*100, h: (r.height/p.height)*100,
                    pw: p.width, ph: p.height
                };
            };
            const move = (e) => {
                if(!m) return;
                e.preventDefault();
                const dx = ((e.clientX - s.x)/s.pw)*100;
                const dy = ((e.clientY - s.y)/s.ph)*100;
                
                if(m==='move') {
                    el.style.left = Math.max(0, Math.min(100-s.w, s.l+dx)) + '%';
                    el.style.top = Math.max(0, Math.min(100-s.h, s.t+dy)) + '%';
                } else {
                    el.style.width = Math.max(5, s.w+dx) + '%';
                    el.style.height = Math.max(5, s.h+dy) + '%';
                }
            };
            const up = (e) => { if(m){ m=null; el.releasePointerCapture(e.pointerId); }};
            
            el.addEventListener('pointerdown', down);
            el.addEventListener('pointermove', move);
            el.addEventListener('pointerup', up);
        }

        window.onload = () => {
            setupDrag('roi1');
            setupDrag('roi2');
            updUI();
        };
    </script>
</body>
</html>
