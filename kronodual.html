<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KRONO DUAL V.1.0 Gold</title>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- Firebase (boilerplate standard) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            signInAnonymously(auth).catch(console.error);
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: {
                            100: '#FFF9C4',
                            300: '#FFF176',
                            400: '#FFEE58',
                            500: '#FFD700', // Classic Gold
                            600: '#FFC107',
                            700: '#FFA000',
                            800: '#FF8F00',
                            900: '#B8860B'  // Dark Gold
                        },
                        dark: {
                            900: '#0a0a0a',
                            800: '#111111'
                        }
                    },
                    fontFamily: {
                        arial: ['Arial', 'Helvetica', 'sans-serif'],
                    },
                    boxShadow: {
                        'gold': '0 0 15px rgba(255, 215, 0, 0.3)',
                        'gold-inset': 'inset 0 0 10px rgba(255, 215, 0, 0.1)'
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos Base Gold */
        body {
            background-color: #050505;
            background-image: radial-gradient(circle at 50% 0%, #332a00 0%, #000000 100%);
            color: #FFD700;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none;
            font-family: 'Arial', sans-serif;
        }

        /* Efectos Ne√≥n Gold */
        .neon-text-g { text-shadow: 0 0 10px rgba(255, 215, 0, 0.7); }
        .neon-border-g { box-shadow: 0 0 10px rgba(255, 215, 0, 0.2), inset 0 0 10px rgba(255, 215, 0, 0.1); border-color: #FFD700; }

        /* Sem√°foro */
        .bulb {
            width: 20px; height: 20px; border-radius: 50%;
            background-color: #222; border: 2px solid #554400;
            transition: all 0.1s;
        }
        .bulb.red { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; border-color: #ffaaaa; }
        .bulb.green { background-color: #22c55e; box-shadow: 0 0 15px #22c55e; border-color: #aaffaa; }

        /* ROIs - Dorados y Visibles */
        .roi {
            position: absolute; 
            border: 2px dashed #FFD700;
            display: none; 
            cursor: move; 
            z-index: 50; 
            touch-action: none;
            box-sizing: border-box; 
            background: rgba(255, 215, 0, 0.1);
            width: 15%; 
            height: 20%;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        
        /* Posiciones iniciales */
        #roi1 { top: 30%; left: 20%; color: #FFD700; }
        #roi2 { top: 30%; left: 60%; color: #FFA000; border-color: #FFA000; }

        .roi.active { 
            border-style: solid; 
            border-width: 4px; 
            background: rgba(255, 255, 255, 0.4); 
            box-shadow: 0 0 20px #FFD700;
            border-color: #FFF;
        }
        
        .roi-handle {
            position: absolute; bottom: 0; right: 0; width: 30px; height: 30px;
            background: linear-gradient(135deg, transparent 50%, #FFD700 50%);
            cursor: nwse-resize; 
            opacity: 1;
        }

        /* Botones Dorados */
        .btn-gold {
            background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
            border: 1px solid #B8860B;
            color: #FFD700;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
        }
        .btn-gold:hover:not(:disabled) {
            background: linear-gradient(180deg, #332a00 0%, #1a1500 100%);
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }
        .btn-gold:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #444;
            color: #666;
        }

        .btn-adj {
            background: #111; color: #FFD700; border: 1px solid #B8860B;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; font-weight: bold; cursor: pointer; 
            font-size: 1.25rem; /* CORREGIDO: antes dec√≠a text-xl: */
        }
        .btn-adj:active { background: #FFD700; color: #000; }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .slide-down { animation: slideDown 0.3s ease-out forwards; }
        @keyframes slideDown { from { max-height: 0; opacity: 0; } to { max-height: 800px; opacity: 1; } }
        
        .chart-bar { transition: height 0.3s ease; }
        
        /* Inputs Gold */
        input[type=range] { accent-color: #FFD700; }
    </style>
</head>
<body class="flex flex-col min-h-screen p-2 max-w-4xl mx-auto w-full font-arial">

    <!-- ERROR HANDLER -->
    <div id="err" class="hidden bg-red-900/80 border border-red-500 text-white p-2 text-center text-sm rounded mb-2"></div>
    <script>window.onerror=function(m){const e=document.getElementById('err');e.classList.remove('hidden');e.innerHTML='ERROR: '+m;}</script>

    <!-- HEADER -->
    <header class="bg-black/60 backdrop-blur-xl border border-gold-900 rounded-xl p-3 shadow-gold flex flex-wrap justify-between items-center gap-3 mb-4 sticky top-0 z-40">
        <div class="flex flex-col">
            <h1 class="text-2xl font-black italic tracking-tighter leading-none text-white">
                KRONODUAL <span class="text-gold-500 neon-text-g">V.1.0</span>
            </h1>
            <span class="text-[10px] font-bold text-gold-700 tracking-widest uppercase">By Albert Closa</span>
        </div>

        <div class="flex gap-2">
            <button onclick="toggleConfig()" class="btn-gold text-[10px] py-2 px-4 rounded-full flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.35a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.52a2 2 0 0 1-1 1.73l-.15.08a2 2 0 0 0-.73 2.73l.78 1.35a2 2 0 0 0-2.73-.73l-.15-.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V2a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                AJUSTES
            </button>
            <button onclick="showRecords()" class="btn-gold text-[10px] py-2 px-4 rounded-full flex items-center gap-2">
                üèÜ HISTORIAL
            </button>
        </div>

        <div class="bg-black p-2 rounded-full border border-gold-900 flex gap-2 shadow-inner">
            <div id="l1" class="bulb"></div><div id="l2" class="bulb"></div><div id="l3" class="bulb"></div><div id="l4" class="bulb"></div><div id="l5" class="bulb"></div>
        </div>
    </header>

    <!-- PANEL DE AJUSTES -->
    <div id="config" class="hidden w-full bg-dark-900/90 backdrop-blur-xl border-x border-b border-gold-900 rounded-b-xl p-4 mb-4 shadow-2xl relative z-30">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-4">
            <!-- COLUMNA P1 -->
            <div class="bg-yellow-900/10 p-3 rounded-lg border border-yellow-700/30">
                <label class="text-xs font-bold text-gold-400 mb-1 block">PILOTO 1 (ORO)</label>
                <input id="in-p1-n" value="Piloto 1" onchange="updUI()" class="w-full bg-black border border-gold-900 rounded p-2 text-sm text-gold-100 mb-2 focus:border-gold-500 outline-none">
                <input id="in-p1-c" value="Golden Bull" onchange="updUI()" class="w-full bg-black border border-gold-900 rounded p-2 text-xs text-gold-600 mb-3 focus:border-gold-500 outline-none">
                
                <label class="text-[10px] font-bold text-gold-700 uppercase">Tono P1</label>
                <select id="snd-p1" onchange="previewTone(this.value)" class="w-full bg-black border border-gold-900 rounded p-2 text-sm mb-3 text-gold-300">
                    <option value="C5">Tono Alto (C5)</option>
                    <option value="A4">Tono Medio (A4)</option>
                    <option value="F4">Tono Bajo (F4)</option>
                    <option value="E6">Digital (E6)</option>
                </select>

                <label class="text-[10px] font-bold text-gold-700 uppercase flex justify-between">
                    <span>Umbral P1</span> <span id="lbl-sens-p1" class="text-gold-400 font-bold text-lg">100</span>
                </label>
                <div class="flex items-center gap-3 mt-2">
                    <button class="btn-adj" onclick="adjSens(1, -5)">-</button>
                    <input type="range" id="in-sens-p1" min="0" max="255" value="100" oninput="updSensUI(1)" class="flex-1 h-4 bg-dark-800 rounded-lg appearance-none cursor-pointer">
                    <button class="btn-adj" onclick="adjSens(1, 5)">+</button>
                </div>
            </div>

            <!-- COLUMNA P2 -->
            <div class="bg-orange-900/10 p-3 rounded-lg border border-orange-900/30">
                <label class="text-xs font-bold text-orange-400 mb-1 block">PILOTO 2 (BRONCE)</label>
                <input id="in-p2-n" value="Piloto 2" onchange="updUI()" class="w-full bg-black border border-orange-900 rounded p-2 text-sm text-gold-100 mb-2 focus:border-orange-500 outline-none">
                <input id="in-p2-c" value="Bronze Horse" onchange="updUI()" class="w-full bg-black border border-orange-900 rounded p-2 text-xs text-orange-600 mb-3 focus:border-orange-500 outline-none">
                
                <label class="text-[10px] font-bold text-orange-700 uppercase">Tono P2</label>
                <select id="snd-p2" onchange="previewTone(this.value)" class="w-full bg-black border border-orange-900 rounded p-2 text-sm mb-3 text-gold-300">
                    <option value="F4">Tono Bajo (F4)</option>
                    <option value="A4">Tono Medio (A4)</option>
                    <option value="C5">Tono Alto (C5)</option>
                    <option value="C3">Grave (C3)</option>
                </select>

                <label class="text-[10px] font-bold text-orange-700 uppercase flex justify-between">
                    <span>Umbral P2</span> <span id="lbl-sens-p2" class="text-orange-400 font-bold text-lg">100</span>
                </label>
                <div class="flex items-center gap-3 mt-2">
                    <button class="btn-adj border-orange-900 text-orange-400" onclick="adjSens(2, -5)">-</button>
                    <input type="range" id="in-sens-p2" min="0" max="255" value="100" oninput="updSensUI(2)" class="flex-1 h-4 bg-dark-800 rounded-lg appearance-none cursor-pointer accent-orange-500">
                    <button class="btn-adj border-orange-900 text-orange-400" onclick="adjSens(2, 5)">+</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 border-t border-gold-900/50 pt-4">
            <div class="w-full">
                <label class="text-xs font-bold text-gold-700 mb-1 block">VUELTAS DE CARRERA</label>
                <select id="in-laps" onchange="updUI()" class="w-full bg-black border border-gold-900 rounded p-2 text-sm text-gold-300">
                    <option value="5">5 Vueltas (Sprint)</option>
                    <option value="10" selected>10 Vueltas (Standard)</option>
                    <option value="20">20 Vueltas (Long)</option>
                    <option value="50">50 Vueltas (Endurance)</option>
                    <option value="9999">Pr√°ctica Libre (‚àû)</option>
                </select>
            </div>
            <div class="w-full flex items-center justify-center pt-6">
                <label class="flex items-center cursor-pointer gap-3">
                    <input type="checkbox" id="voice-chk" checked class="w-5 h-5 accent-gold-500 rounded bg-black border-gold-700">
                    <span class="text-sm font-bold text-gold-500">LOCUTOR (TTS) ACTIVO</span>
                </label>
            </div>
        </div>
    </div>

    <!-- MAIN TIMER -->
    <div class="relative bg-gradient-to-br from-dark-900 to-black border border-gold-900 rounded-2xl p-6 text-center shadow-[0_0_20px_rgba(184,134,11,0.2)] mb-4 overflow-hidden">
        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDIwIDIwIiBmaWxsPSJub25lIiBzdHJva2U9InJnYmEoMjU1LDIxNSwwLDAuMDUpIj48cGF0aCBkPSJNMCAwaDIwdjIwSDB6Ii8+PC9zdmc+')] opacity-20"></div>
        <div class="relative z-10">
            <div class="text-[10px] font-bold text-gold-600 tracking-[0.3em] uppercase mb-1">Tiempo de Carrera</div>
            <div id="main-timer" class="text-6xl sm:text-7xl font-black text-white tabular-nums tracking-tight drop-shadow-[0_0_10px_rgba(255,215,0,0.3)] font-arial">
                00:00.00
            </div>
            <div id="lap-counter" class="text-xs font-bold text-yellow-400 tracking-[0.2em] uppercase mt-2">
                PREPARADO
            </div>
        </div>
    </div>

    <!-- VIDEO ZONE -->
    <div class="bg-dark-900 border border-gold-900 rounded-xl p-4 shadow-lg mb-4">
        <div class="flex justify-between items-center mb-3">
            <button id="btn-cam" onclick="toggleCam()" class="btn-gold text-[10px] py-2 px-4 rounded-full shadow-none border-gold-800 text-gold-500">
                ENCENDER C√ÅMARA
            </button>
            <div class="flex gap-2 text-[10px] font-bold bg-black/50 px-3 py-1 rounded-full border border-gold-900 font-arial">
                <span class="text-gold-400">P1: <b id="val-p1">0</b></span>
                <span class="text-gold-800">|</span>
                <span class="text-orange-400">P2: <b id="val-p2">0</b></span>
            </div>
        </div>

        <!-- MODIFICADO: Aumentado de h-[25vh] a h-[35vh] para mejor aspecto sin scroll -->
        <div class="relative w-full h-[35vh] bg-black rounded-lg overflow-hidden border-2 border-gold-900 shadow-inner">
            <div id="cam-msg" class="absolute inset-0 flex flex-col items-center justify-center text-gold-800">
                <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                <p class="text-xs font-bold">C√ÅMARA APAGADA</p>
            </div>
            <video id="webcam" class="w-full h-full object-fill hidden" autoplay playsinline muted></video>
            
            <!-- OVERLAY RECORD -->
            <div id="record-overlay" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/90 border-2 border-gold-500 p-6 rounded-xl text-center opacity-0 pointer-events-none transition-all transform scale-90 z-50 shadow-[0_0_50px_rgba(255,215,0,0.5)]">
                <div class="text-gold-400 text-2xl font-black uppercase mb-1 font-arial">¬°NUEVO R√âCORD!</div>
                <div id="rec-data" class="text-white text-xl font-bold font-arial tracking-widest">--.---</div>
            </div>

            <div id="roi1" class="roi"><div class="absolute -top-6 left-0 bg-gold-500 text-black text-[10px] font-bold px-2 rounded-sm border border-white">P1</div><div class="roi-handle"></div></div>
            <div id="roi2" class="roi"><div class="absolute -top-6 left-0 bg-orange-600 text-black text-[10px] font-bold px-2 rounded-sm border border-white">P2</div><div class="roi-handle"></div></div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4">
            <button id="btn-start" onclick="toggleRace()" disabled class="btn-gold py-3 px-4 rounded-xl text-sm shadow-md disabled:opacity-50">
                INICIAR
            </button>
            <button id="btn-reset" onclick="resetRace()" disabled class="bg-dark-800 text-red-500 font-black py-3 px-4 rounded-xl text-sm transition-all border border-red-900/30 shadow-md hover:bg-red-900/10 disabled:opacity-50 disabled:cursor-not-allowed">
                RESET
            </button>
        </div>
    </div>

    <!-- TELEMETRY CARDS -->
    <div class="bg-dark-900/80 backdrop-blur-lg border border-gold-900 rounded-xl p-4 shadow-lg mb-4">
        <h3 class="text-left text-xs font-bold text-gold-500 tracking-[0.2em] uppercase border-b border-gold-900 pb-2 mb-4 neon-text-g pl-1">Telemetr√≠a en Vivo</h3>
        
        <div class="grid grid-cols-2 gap-4">
            <!-- P1 CARD -->
            <div class="bg-gradient-to-b from-dark-800 to-black border-l-4 border-gold-500 p-3 rounded shadow-lg relative overflow-hidden neon-border-g">
                <div class="absolute top-0 right-0 p-1 opacity-10"><h1 class="text-4xl font-black text-gold-500">1</h1></div>
                <h3 class="text-lg font-black text-gold-400 leading-none" id="disp-p1-n">P1</h3>
                <span class="text-[10px] font-bold text-gold-700 uppercase tracking-wider block mb-3" id="disp-p1-c">CAR 1</span>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-dark-800/50 p-1 rounded border border-gold-900/30"><span class="text-[8px] text-gold-600 block font-bold">VUELTAS</span><span id="disp-p1-l" class="text-sm font-bold text-white font-arial">0</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-gold-900/30"><span class="text-[8px] text-gold-600 block font-bold">TOTAL</span><span id="disp-p1-tot" class="text-sm font-bold text-white font-arial">00:00</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-gold-900/30"><span class="text-[8px] text-gold-600 block font-bold">VELOCIDAD</span><span id="disp-p1-spd" class="text-xs font-bold text-white font-arial">0</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-gold-900/30"><span class="text-[8px] text-gold-600 block font-bold">√öLTIMA</span><span id="disp-p1-last" class="text-xs font-bold text-white font-arial">--.--</span></div>
                    <div class="col-span-2 bg-yellow-900/20 border border-gold-500/30 p-2 rounded text-center">
                        <span class="text-[8px] text-gold-200 block font-bold uppercase tracking-widest">MEJOR TIEMPO</span>
                        <span id="disp-p1-best" class="text-xl font-black text-white font-arial drop-shadow-[0_0_5px_rgba(255,215,0,0.5)]">--.--</span>
                    </div>
                </div>
            </div>

            <!-- P2 CARD -->
            <div class="bg-gradient-to-b from-dark-800 to-black border-l-4 border-orange-600 p-3 rounded shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 p-1 opacity-10"><h1 class="text-4xl font-black text-orange-600">2</h1></div>
                <h3 class="text-lg font-black text-orange-500 leading-none" id="disp-p2-n">P2</h3>
                <span class="text-[10px] font-bold text-orange-800 uppercase tracking-wider block mb-3" id="disp-p2-c">CAR 2</span>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-dark-800/50 p-1 rounded border border-orange-900/30"><span class="text-[8px] text-orange-700 block font-bold">VUELTAS</span><span id="disp-p2-l" class="text-sm font-bold text-white font-arial">0</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-orange-900/30"><span class="text-[8px] text-orange-700 block font-bold">TOTAL</span><span id="disp-p2-tot" class="text-sm font-bold text-white font-arial">00:00</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-orange-900/30"><span class="text-[8px] text-orange-700 block font-bold">VELOCIDAD</span><span id="disp-p2-spd" class="text-xs font-bold text-white font-arial">0</span></div>
                    <div class="bg-dark-800/50 p-1 rounded border border-orange-900/30"><span class="text-[8px] text-orange-700 block font-bold">√öLTIMA</span><span id="disp-p2-last" class="text-xs font-bold text-white font-arial">--.--</span></div>
                    <div class="col-span-2 bg-orange-900/20 border border-orange-600/30 p-2 rounded text-center">
                        <span class="text-[8px] text-orange-200 block font-bold uppercase tracking-widest">MEJOR TIEMPO</span>
                        <span id="disp-p2-best" class="text-xl font-black text-white font-arial drop-shadow-[0_0_5px_rgba(255,100,0,0.5)]">--.--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6">
            <h4 class="text-xs font-bold text-gold-500 mb-2 uppercase neon-text-g text-left pl-1">Ritmo de Carrera</h4>
            <div class="bg-dark-800/50 border border-gold-900/50 h-56 rounded relative p-2 pl-8">
                <div class="absolute left-1 top-2 bottom-2 flex flex-col justify-between text-[8px] text-gold-700 font-bold">
                    <span id="chart-max">10s</span>
                    <span id="chart-mid">5s</span>
                    <span>0s</span>
                </div>
                <svg id="chart-svg" class="w-full h-full overflow-visible" preserveAspectRatio="none">
                    <!-- Lines and bars dynamically injected -->
                </svg>
            </div>
        </div>
    </div>

    <!-- MODAL RESULTADOS -->
    <div id="res-modal" class="fixed inset-0 bg-black/80 backdrop-blur-xl z-50 hidden flex items-center justify-center fade-in">
        <div class="bg-dark-900/90 border border-gold-600 w-[95%] max-w-lg max-h-[90vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden slide-down">
            <div class="bg-gradient-to-b from-dark-800 to-black p-6 text-center border-b border-gold-800">
                <div class="text-4xl mb-2">üèÜ</div>
                <div class="text-[10px] font-bold text-gold-500 tracking-widest uppercase mb-1">VICTORIA</div>
                <h1 class="text-3xl font-black text-white uppercase leading-none mb-1 neon-text-g" id="res-winner">NOMBRE</h1>
                <span class="text-xs font-bold text-gold-700 uppercase tracking-widest" id="res-car">COCHE</span>
                
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <div class="bg-yellow-900/20 border border-gold-600/30 p-2 rounded col-span-2">
                        <span class="text-[10px] text-gold-500 font-bold block">TIEMPO TOTAL</span>
                        <span class="text-xl font-arial font-bold text-yellow-400" id="res-total">--:--</span>
                    </div>
                    <div class="bg-dark-800 p-2 rounded border border-gold-900/30">
                        <span class="text-[10px] text-gray-500 font-bold block">MEJOR VUELTA</span>
                        <span class="text-lg font-arial font-bold text-gold-400" id="res-best">--.--</span>
                    </div>
                    <div class="bg-dark-800 p-2 rounded border border-gold-900/30">
                        <span class="text-[10px] text-gray-500 font-bold block">VEL. MEDIA</span>
                        <span class="text-lg font-bold text-white" id="res-spd-avg">0</span>
                    </div>
                    <div class="bg-dark-800 p-2 rounded border border-gold-900/30">
                        <span class="text-[10px] text-gray-500 font-bold block">TIEMPO MEDIO</span>
                        <span class="text-lg font-arial font-bold text-white" id="res-avg">--.--</span>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <h4 class="text-xs font-bold text-gold-400 border-b border-gold-900 pb-1 mb-2">P1 TIEMPOS</h4>
                        <table class="w-full text-xs text-gray-400">
                            <tbody id="tb-p1" class="divide-y divide-gray-800"></tbody>
                        </table>
                    </div>
                    <div class="w-1/2">
                        <h4 class="text-xs font-bold text-orange-600 border-b border-orange-900 pb-1 mb-2">P2 TIEMPOS</h4>
                        <table class="w-full text-xs text-gray-400">
                            <tbody id="tb-p2" class="divide-y divide-gray-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-black border-t border-gold-900 flex gap-3">
                <button onclick="closeModal('res-modal')" class="flex-1 bg-dark-800 hover:bg-dark-700 text-white font-bold py-3 rounded-lg text-xs transition-all border border-gray-700">CERRAR</button>
                <button onclick="newRace()" class="flex-1 btn-gold py-3 rounded-lg text-xs transition-all shadow-lg uppercase">NUEVA CARRERA</button>
            </div>
        </div>
    </div>

    <!-- MODAL RECORDS -->
    <div id="rec-modal" class="fixed inset-0 bg-black/80 backdrop-blur-xl z-50 hidden flex items-center justify-center fade-in">
        <div class="bg-dark-900/90 border border-gold-600/50 w-[95%] max-w-3xl max-h-[90vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden slide-down">
            <div class="bg-gradient-to-r from-black via-yellow-900/20 to-black p-6 text-center border-b border-gold-600/30">
                <div class="text-3xl mb-2">üëë</div>
                <h1 class="text-2xl font-black text-gold-500 uppercase tracking-widest neon-text-g">Hall of Fame</h1>
            </div>
            
            <div class="flex-1 overflow-y-auto p-0">
                <table class="w-full text-xs text-left">
                    <thead class="bg-slate-950 text-slate-400 sticky top-0">
                        <tr>
                            <th class="p-3 font-bold">FECHA</th>
                            <th class="p-3 font-bold text-cyan-400">PILOTO</th>
                            <th class="p-3 font-bold">COCHE</th>
                            <th class="p-3 font-bold text-yellow-400 text-right font-arial">TIEMPO</th>
                            <th class="p-3 font-bold text-right font-arial">VEL.</th>
                        </tr>
                    </thead>
                    <tbody id="records-list" class="divide-y divide-slate-800 text-slate-300"></tbody>
                </table>
            </div>

            <div class="p-4 bg-slate-950 border-t border-slate-800 flex justify-between">
                <button onclick="closeModal('rec-modal')" class="text-yellow-500 text-xs font-bold hover:text-white transition-colors">CERRAR</button>
                <button id="btn-del-rec" onclick="tryClearRecords(this)" class="text-red-500 text-xs font-bold hover:text-red-400 transition-colors uppercase">BORRAR HISTORIAL</button>
            </div>
        </div>
    </div>

    <canvas id="cv" class="hidden"></canvas>

    <script>
        // --- UTILIDADES ---
        const get = (id) => document.getElementById(id);
        const set = (id, txt) => { const el = get(id); if(el) el.innerText = txt; }
        const fmt = (ms) => (ms/1000).toFixed(2);
        const fmtTime = (ms) => {
            let m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), i=Math.floor((ms%1000)/10);
            return (m<10?'0':'')+m+":"+(s<10?'0':'')+s+"."+(i<10?'0':'')+i;
        };

        // --- ESTADO ---
        const state = {
            race: false, cam: false, start: 0, timer: null,
            countdown: false, aborted: false,
            flags: { f5: false, f1: false },
            p1: { n:'P1', c:'C1', laps:0, best:999999, h:[], last:0, fin:false, blk:false, total:0 },
            p2: { n:'P2', c:'C2', laps:0, best:999999, h:[], last:0, fin:false, blk:false, total:0 },
            cfg: { laps:10 } 
        };

        const vid = get('webcam');
        const cv = get('cv');
        const ctx = cv.getContext('2d', { willReadFrequently: true });

        // --- TONE.JS SETUP ---
        let synth, polySynth;
        
        async function initAudio() {
            if(typeof Tone === 'undefined') {
                console.warn('Tone.js no cargado');
                return;
            }
            if(!synth) {
                await Tone.start();
                synth = new Tone.Synth().toDestination();
                polySynth = new Tone.PolySynth(Tone.Synth).toDestination();
                // Ajustes de volumen
                synth.volume.value = -5;
                polySynth.volume.value = -5;
            }
        }

        function playTone(note) {
            if(synth) synth.triggerAttackRelease(note, "8n");
        }

        function previewTone(note) {
            initAudio().then(() => playTone(note)).catch(e=>console.log(e));
        }

        async function playStartSequence() {
            await initAudio();
            // 5 Sem√°foros
            for(let i=1; i<=5; i++) {
                if(state.aborted) return;
                get('l'+i).classList.add('red');
                if(synth) synth.triggerAttackRelease("C4", "8n"); // Nota Roja
                await new Promise(r => setTimeout(r, 900));
            }
            if(state.aborted) return;
            
            // Random delay
            await new Promise(r => setTimeout(r, Math.random()*1500 + 500));
            if(state.aborted) return;

            // Green Light
            for(let i=1; i<=5; i++) { get('l'+i).classList.remove('red'); get('l'+i).classList.add('green'); }
            // Acorde de salida (C5 Major)
            if(polySynth) polySynth.triggerAttackRelease(["C5", "E5", "G5"], "2n");
            
            startRaceLogic();
        }

        function playFalseStartSound() {
            if(synth) {
                const now = Tone.now();
                synth.triggerAttackRelease("G3", "8n", now);
                synth.triggerAttackRelease("G3", "8n", now + 0.2);
            }
        }

        function playLapSound(id) {
            if(!synth) return;
            const note = get('snd-p'+id).value;
            synth.triggerAttackRelease(note, "16n");
        }

        function playBell() {
            // Sonido de campana simulado (arm√≥nicos met√°licos)
            if(!polySynth) return;
            polySynth.triggerAttackRelease(["C6", "E6"], "8n");
        }

        // --- TTS (Voz) ---
        function speak(txt) {
            if(get('voice-chk').checked && 'speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                u.rate = 1.2; 
                u.lang = 'es-ES';
                window.speechSynthesis.speak(u);
            }
        }

        // --- CAMARA ---
        async function toggleCam() {
            const btn = get('btn-cam');
            if(!state.cam) {
                try {
                    await initAudio(); // Init audio context on user gesture
                    let stream;
                    try { stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); }
                    catch(e) { stream = await navigator.mediaDevices.getUserMedia({video:true}); }
                    
                    vid.srcObject = stream;
                    vid.onloadedmetadata = () => {
                        vid.play();
                        cv.width = 320; cv.height = 240;
                        state.cam = true;
                        vid.classList.remove('hidden');
                        get('cam-msg').classList.add('hidden');
                        get('roi1').style.display='block'; get('roi2').style.display='block';
                        
                        btn.innerText = "APAGAR C√ÅMARA";
                        btn.classList.replace('text-gold-500', 'text-red-500');
                        btn.classList.replace('border-gold-800', 'border-red-900');
                        
                        get('btn-start').disabled = false;
                        loop();
                    };
                } catch(e) { alert("Error Cam: "+e); }
            } else {
                if(vid.srcObject) vid.srcObject.getTracks().forEach(t=>t.stop());
                state.cam = false; 
                vid.classList.add('hidden');
                get('cam-msg').classList.remove('hidden');
                get('roi1').style.display='none'; get('roi2').style.display='none';
                
                btn.innerText = "ENCENDER C√ÅMARA";
                btn.classList.replace('text-red-500', 'text-gold-500');
                btn.classList.replace('border-red-900', 'border-gold-800');
                
                get('btn-start').disabled = true;
            }
        }

        function loop() {
            if(!state.cam) return;
            ctx.drawImage(vid, 0, 0, cv.width, cv.height);
            check(1); check(2);
            requestAnimationFrame(loop);
        }

        // --- DETECCI√ìN & AJUSTE UMBRAL ---
        function adjSens(id, val) {
            const el = get('in-sens-p'+id);
            let n = parseInt(el.value) + val;
            if(n<0) n=0; if(n>255) n=255;
            el.value = n;
            updSensUI(id);
        }

        function updSensUI(id) {
            const v = get('in-sens-p'+id).value;
            get('lbl-sens-p'+id).innerText = v;
        }

        function check(id) {
            const roi = get('roi'+id);
            const l = parseFloat(roi.style.left)||20, t=parseFloat(roi.style.top)||40, w=parseFloat(roi.style.width)||15, h=parseFloat(roi.style.height)||15;
            
            const rx = Math.floor((l/100)*cv.width), ry = Math.floor((t/100)*cv.height);
            const rw = Math.floor((w/100)*cv.width), rh = Math.floor((h/100)*cv.height);
            
            if(rw<=0 || rh<=0) return;
            
            const d = ctx.getImageData(rx, ry, rw, rh).data;
            let s=0, c=0;
            for(let i=0; i<d.length; i+=16) { s+=(d[i]+d[i+1]+d[i+2])/3; c++; }
            const avg = Math.floor(s/c);
            
            set('val-p'+id, avg);
            
            const umbral = parseInt(get('in-sens-p'+id).value);
            
            if(avg < umbral) {
                roi.classList.add('active');
                if(state.race && !state['p'+id].blk && !state['p'+id].fin) {
                    state['p'+id].blk = true; lap(id);
                } else if(state.countdown && !state['p'+id].blk && !state.aborted) {
                    state['p'+id].blk = true;
                    triggerFalseStart(id);
                }
            } else {
                roi.classList.remove('active');
                state['p'+id].blk = false;
            }
        }

        // --- L√ìGICA DE CARRERA ---
        function toggleRace() {
            const btn = get('btn-start');
            if(state.race) {
                stopRace();
                saveSessionRecords(); // Guardar al parar manualmente
                btn.innerText = "INICIAR";
                btn.classList.remove('text-red-400');
            } else {
                startCountdown();
            }
        }

        async function startCountdown() {
            state.aborted = false;
            state.countdown = true;
            get('config').classList.add('hidden'); // Close config
            get('btn-start').disabled = true;
            get('btn-reset').disabled = true;
            
            // Reset Lights
            for(let i=1; i<=5; i++) get('l'+i).className = 'bulb';
            
            set('main-timer', "00:00.00");
            set('lap-counter', "PREPARADO");
            
            speak("Pilotos a sus puestos");
            await playStartSequence();
        }

        function startRaceLogic() {
            state.countdown = false;
            state.race = true;
            state.start = Date.now();
            resetData();
            
            state.timer = setInterval(()=>{
                set('main-timer', fmtTime(Date.now()-state.start));
            }, 37);
            
            const btn = get('btn-start');
            btn.disabled = false;
            btn.innerText = "PARAR";
            btn.classList.add('text-red-400');
        }

        function triggerFalseStart(id) {
            state.aborted = true;
            state.countdown = false;
            playFalseStartSound();
            const name = get('in-p'+id+'-n').value;
            set('main-timer', "SALIDA NULA");
            set('lap-counter', "CULPABLE: "+name);
            get('main-timer').style.color = '#ef4444';
            
            for(let i=1; i<=5; i++) { get('l'+i).className = 'bulb red'; }
            
            get('btn-start').disabled = false;
            get('btn-start').innerText = "REINICIAR";
            speak("Salida nula de " + name);
        }

        function stopRace() {
            state.race = false;
            clearInterval(state.timer);
            get('btn-reset').disabled = false;
        }

        function resetRace() {
            stopRace();
            set('main-timer', "00:00.00");
            get('main-timer').style.color = 'white';
            set('lap-counter', "PREPARADO");
            for(let i=1; i<=5; i++) get('l'+i).className = 'bulb';
            
            const btn = get('btn-start');
            btn.innerText = "INICIAR";
            btn.classList.remove('text-red-400');
            resetData();
        }

        function lap(id) {
            const now = Date.now();
            // Anti-bounce 2s
            if(now - state['p'+id].last < 2000) return;
            
            const t = now - state['p'+id].last;
            state['p'+id].last = now;
            state['p'+id].laps++;
            state['p'+id].h.push(t);
            
            playLapSound(id);

            // Record?
            if(t < state['p'+id].best) {
                state['p'+id].best = t;
                const name = get(`in-p${id}-n`).value;
                speak(`R√©cord ${name}, ${fmt(t)}`);
                showOverlay(`${name} - ${fmt(t)}`);
            }

            updUI(); drawChart();

            // Check laps
            const max = parseInt(get('in-laps').value);
            if(max !== 9999) {
                const rem = max - state['p'+id].laps;
                if(rem === 5 && !state.flags.f5) {
                    state.flags.f5 = true;
                    speak("Quedan 5 vueltas");
                }
                if(rem === 1 && !state.flags.f1) {
                    state.flags.f1 = true;
                    playBell();
                    speak("√öltima vuelta");
                }
                if(state['p'+id].laps >= max) {
                    finish(id, now);
                }
            }
        }

        function finish(id, now) {
            state['p'+id].fin = true;
            state['p'+id].total = now - state.start;
            
            // Si el otro ya acab√≥, o soy el primero
            const oid = id===1?2:1;
            if(!state['p'+oid].fin) {
                stopRace();
                saveSessionRecords(); // Guardar resultados al terminar la carrera
                const name = get(`in-p${id}-n`).value;
                speak(`Victoria para ${name}`);
                showRes(id);
            }
        }
        
        // --- GUARDADO DE RESULTADOS (SOLO AL FINAL) ---
        function saveSessionRecords() {
            [1,2].forEach(id => {
                const p = state['p'+id];
                // Solo guarda si ha dado vueltas y tiene un tiempo v√°lido
                if(p.h.length > 0 && p.best < 999999) {
                     // Calcular velocidad de la MEJOR vuelta
                     const bestSpd = (25 / (p.best/1000)) * 3.6;
                     saveRecord(p.n, p.c, p.best, bestSpd);
                }
            });
        }

        function showOverlay(txt) {
            const ov = get('record-overlay');
            get('rec-data').innerText = txt;
            ov.classList.replace('opacity-0', 'opacity-100');
            ov.classList.replace('scale-90', 'scale-100');
            setTimeout(()=>{
                ov.classList.replace('opacity-100', 'opacity-0');
                ov.classList.replace('scale-100', 'scale-90');
            }, 2500);
        }

        // --- UI UPDATES ---
        function updUI() {
            const max = get('in-laps').value;
            [1,2].forEach(id=>{
                const p = state['p'+id];
                p.n = get('in-p'+id+'-n').value;
                p.c = get('in-p'+id+'-c').value;
                
                set('disp-p'+id+'-n', p.n);
                set('disp-p'+id+'-c', p.c);
                set('disp-p'+id+'-l', p.laps);
                
                // Last lap
                const last = p.h.length ? p.h[p.h.length-1] : 0;
                set('disp-p'+id+'-last', last ? fmt(last) : "--.--");
                
                // Best
                set('disp-p'+id+'-best', p.best<999999 ? fmt(p.best) : "--.--");
                
                // Total
                const tot = p.h.reduce((a,b)=>a+b,0);
                set('disp-p'+id+'-tot', tot ? fmtTime(tot) : "00:00");
                
                // Speed (simulada basada en last lap)
                const spd = last ? ((25/(last/1000))*3.6).toFixed(1) : 0;
                set('disp-p'+id+'-spd', spd+" km/h");
            });
            
            const lead = Math.max(state.p1.laps, state.p2.laps);
            set('lap-counter', `VUELTA ${lead} / ${max==='9999'?'‚àû':max}`);
        }

        // --- GRAFICA (GOLD) ---
        function drawChart() {
            const svg = get('chart-svg');
            // Clear but keep grid
            svg.innerHTML = `
                <line x1="0" y1="25%" x2="100%" y2="25%" stroke="rgba(255,215,0,0.1)" stroke-width="1"></line>
                <line x1="0" y1="50%" x2="100%" y2="50%" stroke="rgba(255,215,0,0.1)" stroke-width="1"></line>
                <line x1="0" y1="75%" x2="100%" y2="75%" stroke="rgba(255,215,0,0.1)" stroke-width="1"></line>
            `;
            
            const h1 = state.p1.h, h2 = state.p2.h;
            const len = Math.max(h1.length, h2.length);
            if(len === 0) return;
            
            const maxT = Math.max(...h1, ...h2, 5000); // Min scale 5s
            
            set('chart-max', (maxT/1000).toFixed(1)+'s');
            set('chart-mid', (maxT/2000).toFixed(1)+'s');
            
            const w = 100/len;
            
            for(let i=0; i<len; i++) {
                const x = i * w;
                // Bar P1 (Gold)
                if(h1[i]) {
                    const h = (h1[i]/maxT)*100;
                    const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    r.setAttribute("x", x+"%"); r.setAttribute("y", (100-h)+"%");
                    r.setAttribute("width", (w/2.2)+"%"); r.setAttribute("height", h+"%");
                    r.setAttribute("fill", "#FFD700"); r.setAttribute("rx", "2");
                    r.classList.add('chart-bar');
                    svg.appendChild(r);
                }
                // Bar P2 (Bronze/Dark Gold)
                if(h2[i]) {
                    const h = (h2[i]/maxT)*100;
                    const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    r.setAttribute("x", (x + w/2)+"%"); r.setAttribute("y", (100-h)+"%");
                    r.setAttribute("width", (w/2.2)+"%"); r.setAttribute("height", h+"%");
                    r.setAttribute("fill", "#B8860B"); r.setAttribute("rx", "2");
                    r.classList.add('chart-bar');
                    svg.appendChild(r);
                }
            }
        }

        // --- RECORDS LOCALSTORAGE ---
        function saveRecord(name, car, time, speed) {
            let recs = [];
            try {
                recs = JSON.parse(localStorage.getItem('krono_dual_v2') || '[]');
            } catch(e) { recs = []; }
            
            // Solo top 10
            const date = new Date().toLocaleDateString();
            const hour = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            
            // Check if better
            recs.push({name, car, time, speed, date, hour});
            recs.sort((a,b)=>a.time - b.time);
            recs = recs.slice(0, 50); // Guardar ultimos 50
            localStorage.setItem('krono_dual_v2', JSON.stringify(recs));
        }

        function showRecords() {
            const tb = get('records-list');
            tb.innerHTML = '';
            let recs = [];
            try {
                recs = JSON.parse(localStorage.getItem('krono_dual_v2') || '[]');
            } catch(e) { recs = []; }
            
            if(recs.length===0) {
                tb.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500">Sin registros</td></tr>';
            } else {
                recs.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-800 hover:bg-gray-800/50";
                    // MODIFICADO: FIX robustez para records antiguos
                    const h = r.hour ? r.hour : '';
                    tr.innerHTML = `
                        <td class="p-3 text-gold-300">
                            ${r.date} <span class="text-[10px] text-gray-500 block">${h}</span>
                        </td>
                        <td class="p-3 text-gold-500 font-bold">${r.name}</td>
                        <td class="p-3 text-gray-400">${r.car}</td>
                        <td class="p-3 text-right text-white font-bold font-arial">${fmt(r.time)}</td>
                        <td class="p-3 text-right text-gray-500 font-arial">${r.speed.toFixed(1)}</td>
                    `;
                    tb.appendChild(tr);
                });
            }
            // Reset button state based on deleteConfirm global var
            const btn = get('btn-del-rec');
            if(btn) {
                if(!deleteConfirm) {
                    btn.innerText = "BORRAR HISTORIAL";
                    btn.className = "text-red-500 text-xs font-bold hover:text-red-400 transition-colors uppercase";
                }
            }
            get('rec-modal').classList.remove('hidden');
        }

        let clearTimer;
        let deleteConfirm = false;

        function tryClearRecords(btn) {
            if (!deleteConfirm) {
                // Primer click: Pedir confirmaci√≥n
                deleteConfirm = true;
                btn.innerText = "¬øEST√ÅS SEGURO?";
                btn.className = "text-white bg-red-600 px-2 py-1 rounded text-xs font-bold uppercase animate-pulse";
                
                clearTimer = setTimeout(() => {
                    deleteConfirm = false;
                    btn.innerText = "BORRAR HISTORIAL";
                    btn.className = "text-red-500 text-xs font-bold hover:text-red-400 transition-colors uppercase";
                }, 3000);
            } else {
                // Segundo click: Confirmado
                clearTimeout(clearTimer);
                deleteConfirm = false;
                
                // FIX CRITICO: Remover explicitamente el item
                try {
                    localStorage.removeItem('krono_dual_v2');
                } catch(e) { console.error(e); }
                
                showRecords();
                
                // Restaurar boton
                btn.innerText = "HISTORIAL BORRADO";
                btn.className = "text-green-500 text-xs font-bold uppercase";
                setTimeout(()=>{
                    btn.innerText = "BORRAR HISTORIAL";
                    btn.className = "text-red-500 text-xs font-bold hover:text-red-400 transition-colors uppercase";
                }, 1500);
            }
        }
        
        // --- MODALES & UTIL ---
        function toggleConfig() { get('config').classList.toggle('hidden'); }
        function closeModal(id) { 
            get(id).classList.add('hidden'); 
            if(id === 'rec-modal') {
                deleteConfirm = false; // Resetear estado al cerrar
                clearTimeout(clearTimer);
            }
        }
        function newRace() { closeModal('res-modal'); resetRace(); }
        
        function showRes(wid) {
            const w = state['p'+wid];
            set('res-winner', w.n); set('res-car', w.c);
            set('res-total', fmtTime(w.total));
            set('res-best', fmt(w.best));
            
            // FIX: AGREGADO CALCULO Y MOSTRADO DE TIEMPO MEDIO
            const avg = w.h.length ? (w.total/w.h.length) : 0;
            const elAvg = get('res-avg');
            if(elAvg) elAvg.innerText = fmt(avg);

            // calc avg speed total
            const avgS = w.total ? ((w.laps*25)/(w.total/1000)*3.6).toFixed(1) : 0;
            set('res-spd-avg', avgS+" km/h");
            
            // Fill tables
            [1,2].forEach(id=>{
                const tb = get('tb-p'+id); tb.innerHTML='';
                state['p'+id].h.forEach((t,i)=>{
                    const best = t===state['p'+id].best;
                    tb.innerHTML += `<tr class="${best?'bg-yellow-900/40 font-bold text-white':''}">
                        <td class="p-2 border-b border-gray-800 font-arial">${i+1}</td>
                        <td class="p-2 border-b border-gray-800 text-right font-arial">${fmt(t)}</td>
                    </tr>`;
                });
            });
            get('res-modal').classList.remove('hidden');
        }
        
        function resetData() {
            [1,2].forEach(id=>{
                state['p'+id].laps=0; state['p'+id].h=[]; state['p'+id].best=999999;
                state['p'+id].last=state.start; state['p'+id].fin=false; state['p'+id].blk=false;
            });
            state.flags = {f5:false, f1:false};
            updUI(); drawChart();
        }

        // --- DRAG LOGIC (ROBUST) ---
        function setupDrag(id) {
            const el = get(id);
            const h = el.querySelector('.roi-handle');
            let m=null, s={};
            
            const down = (e) => {
                if(state.race) return;
                e.preventDefault();
                
                // FIX: Protecci√≥n contra errores de puntero
                try {
                    el.setPointerCapture(e.pointerId);
                } catch(err) {
                    console.log("Pointer capture failed silently", err);
                }
                
                m = (e.target === h) ? 'size' : 'move';
                const r = el.getBoundingClientRect();
                const p = el.parentElement.getBoundingClientRect();
                
                // FIX: Protecci√≥n contra divisi√≥n por cero
                if(p.width === 0 || p.height === 0) return;

                s = {
                    x: e.clientX, y: e.clientY,
                    l: (el.offsetLeft/p.width)*100, t: (el.offsetTop/p.height)*100,
                    w: (r.width/p.width)*100, h: (r.height/p.height)*100,
                    pw: p.width, ph: p.height
                };
            };
            const move = (e) => {
                if(!m || !s.pw) return; // FIX: Check if drag started correctly
                e.preventDefault();
                const dx = ((e.clientX - s.x)/s.pw)*100;
                const dy = ((e.clientY - s.y)/s.ph)*100;
                
                if(m==='move') {
                    el.style.left = Math.max(0, Math.min(100-s.w, s.l+dx)) + '%';
                    el.style.top = Math.max(0, Math.min(100-s.h, s.t+dy)) + '%';
                } else {
                    el.style.width = Math.max(5, s.w+dx) + '%';
                    el.style.height = Math.max(5, s.h+dy) + '%';
                }
            };
            const up = (e) => { 
                if(m){ 
                    m=null; 
                    try { el.releasePointerCapture(e.pointerId); } catch(err){}
                }
            };
            
            el.addEventListener('pointerdown', down);
            el.addEventListener('pointermove', move);
            el.addEventListener('pointerup', up);
            // Fallback para cancelar drag
            el.addEventListener('pointercancel', up);
        }

        // Inicializar Drag
        window.onload = () => {
            setupDrag('roi1');
            setupDrag('roi2');
            updUI();
        };
    </script>
</body>
</html>
