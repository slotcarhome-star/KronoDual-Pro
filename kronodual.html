<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KRONODUAL V.5.2 - UI Tweak</title>
    
    <!-- METADATOS PWA Y PERMISOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KRONODUAL">
    <meta name="application-name" content="KRONODUAL">
    <meta http-equiv="Permissions-Policy" content="camera=(self)">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        
        window.initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config not available. Running in local mode.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); 
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };
        window.initFirebase();
    </script>
    
    <style>
        /* --- ESTILOS ULTRA GOLD / NEON --- */
        body {
            font-family: Arial, sans-serif !important;
            background: radial-gradient(circle at center, #1a1200 0%, #000000 100%);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            min-height: 100vh; color: #fff8e1; overscroll-behavior: none;
        }
        
        /* Panel Oro Met√°lico Brillante */
        .gold-panel {
            background: linear-gradient(135deg, #bf953f 0%, #fcf6ba 25%, #b38728 50%, #fbf5b7 75%, #aa771c 100%);
            border: 2px solid #ffd700;
            border-radius: 16px;
            color: #3e2723;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }

        .gold-input {
            background: rgba(255, 255, 255, 0.9); 
            border: 2px solid #b8860b; color: #3e2723; font-weight: bold; font-family: Arial, sans-serif;
            box-shadow: inset 1px 1px 5px rgba(0,0,0,0.2);
        }
        .gold-input:focus {
            background: #ffffff; border-color: #8b4513; outline: none;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }

        .font-arial { font-family: Arial, sans-serif !important; }

        .neon-gold-title {
            color: #4b3621;
            text-align: left; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.8), 0 0 10px rgba(255,215,0,0.6);
            font-family: Arial, sans-serif;
        }
        
        .traffic-light-container.five-lights { display: flex; gap: 10px; }
        .light {
            width: 30px; height: 30px; border-radius: 50%;
            background-color: #1a1a1a; border: 2px solid #5d4037; 
            box-shadow: inset 0 0 5px #000;
            transition: background-color 0.1s ease, box-shadow 0.1s ease;
        }
        .light.red { background-color: #ff0000; box-shadow: 0 0 30px #ff0000, inset 0 0 10px rgba(255,255,255,0.5); border-color: #ffcccc; }
        .light.green { background-color: #00ff00; box-shadow: 0 0 30px #00ff00, inset 0 0 10px rgba(255,255,255,0.5); border-color: #ccffcc; }

        #video-container {
            position: relative; width: 100%; 
            border: 4px solid #ffd700; background-color: #000; 
            border-radius: 0.5rem; overflow: hidden; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4), inset 0 0 20px rgba(0,0,0,0.5);
            touch-action: none;
        }
        
        #webcam-feed {
            max-height: 320px; object-fit: cover; width: 100%;
            display: block; transform: scaleX(1);
        }

        .movable-rectangle {
            position: absolute; width: 30%; height: 30%; cursor: move;
            background-color: rgba(255, 215, 0, 0.1); 
            box-shadow: 0 0 15px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,255,255,0.1);
            transition: background-color 0.1s ease, border-color 0.1s ease; 
            z-index: 10; box-sizing: border-box; touch-action: none; display: none;
        }
        
        /* ESTADOS ESPECIALES */
        .movable-rectangle.roi-dead {
            border-color: #555 !important;
            background-color: rgba(100, 100, 100, 0.2) !important;
            box-shadow: none !important; opacity: 0.5;
        }
        .movable-rectangle.roi-blocked {
            border-color: #ff0000 !important;
            background-color: rgba(255, 0, 0, 0.2) !important;
            box-shadow: 0 0 20px #ff0000 !important;
        }
        
        /* ROI P1: ORO */
        #roi-p1 { border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
        #roi-p1 .roi-label { background: linear-gradient(45deg, #ffd700, #ffb300); color: #3e2723; text-shadow: none; border-color: #fff; }
        #roi-p1.roi-detected {
            background-color: rgba(255, 215, 0, 0.4) !important;
            border-color: #fff !important; box-shadow: 0 0 50px #ffd700, inset 0 0 20px #fff !important;
        }

        /* ROI P2: COBRE BRILLANTE */
        #roi-p2 { border: 3px solid #ff7f50; box-shadow: 0 0 15px rgba(255, 127, 80, 0.6); }
        #roi-p2 .roi-label { background: linear-gradient(45deg, #ff7f50, #ff4500); color: #fff; text-shadow: 1px 1px 0 #000; border-color: #fff; }
        #roi-p2.roi-detected {
            background-color: rgba(255, 127, 80, 0.4) !important;
            border-color: #fff !important; box-shadow: 0 0 50px #ff7f50, inset 0 0 20px #fff !important;
        }

        .roi-label {
            position: absolute; top: -24px; left: -2px;
            font-weight: 900; font-size: 12px; font-family: Arial, sans-serif;
            padding: 2px 10px; border-radius: 4px;
            pointer-events: none; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        /* BARRAS DE SE√ëAL VISUAL */
        .signal-bar-container {
            position: absolute; bottom: 2px; left: 2px; right: 2px;
            height: 6px; background: rgba(0,0,0,0.8); border: 1px solid #555;
            border-radius: 3px; overflow: hidden; pointer-events: none;
        }
        .signal-bar {
            height: 100%; width: 0%; background: linear-gradient(to right, #00ff00, #ffff00, #ff0000);
            transition: width 0.05s linear;
        }
        
        .detection-val {
            position: absolute; bottom: 10px; right: 2px;
            background-color: rgba(0,0,0,0.7); color: #fff;
            font-size: 10px; padding: 2px 4px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3);
            pointer-events: none; font-weight: bold; font-family: Arial, sans-serif;
        }
        
        /* DEBUG OVERLAY */
        .debug-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
            mix-blend-mode: screen;
        }
        .debug-mode .debug-canvas { opacity: 0.8; }
        .debug-mode .movable-rectangle { background-color: rgba(0,0,0,0.8); border-style: dashed; }
        
        /* MENSAJE DE TEST EN ROI */
        .test-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ff00; font-weight: 900; font-size: 20px; text-transform: uppercase;
            text-shadow: 0 0 10px #000, 0 0 20px #00ff00; pointer-events: none; display: none;
            white-space: nowrap; font-family: Arial, sans-serif; z-index: 20;
        }
        .roi-detected .test-msg { display: block; }
        .roi-blocked .test-msg { display: block; color: #ff0000; text-shadow: 0 0 10px #000; font-size: 14px; }

        .resize-handle {
            position: absolute; width: 34px; height: 34px;
            background: radial-gradient(circle, #fff 0%, #ffd700 100%);
            border: 2px solid #fff; border-radius: 50%;
            z-index: 20; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            touch-action: none; 
            display: flex; align-items: center; justify-content: center;
        }
        .resize-handle::after {
            content: ''; width: 10px; height: 10px; background: #333; border-radius: 50%;
        }

        .handle-tl { top: -17px; left: -17px; cursor: nwse-resize; } 
        .handle-br { bottom: -17px; right: -17px; cursor: nwse-resize; } 
        
        .timer-value {
            font-size: 1.1rem; line-height: 1.5rem; 
            white-space: nowrap; color: #2b2005; font-weight: 900;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.4); font-family: Arial, sans-serif;
        }
        @media (min-width: 640px) { .timer-value { font-size: 1.25rem; } }
        
        .telemetry-grid-twin {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%;
        }
        .telemetry-col { display: flex; flex-direction: column; gap: 4px; }
        .telemetry-item {
            display: flex; flex-direction: column; padding: 4px 6px; border-radius: 6px;
            background: linear-gradient(to bottom, #fffef0, #e6d6aa);
            border: 1px solid #b38728; box-shadow: inset 0 1px 0 #fff, 0 2px 4px rgba(0,0,0,0.1);
        }
        .telemetry-label {
            font-size: 0.55rem; font-weight: 800; color: #785c15; 
            margin-bottom: 0px; text-transform: uppercase; letter-spacing: 0.05em; font-family: Arial, sans-serif;
        }
        .telemetry-data { font-size: 0.75rem; font-weight: 900; color: #2b2005; font-family: Arial, sans-serif; line-height: 1;}

        .bg-p1-soft { background-color: #fff9c4; border-left: 4px solid #ffd700; } 
        .bg-p2-soft { background-color: #ffccbc; border-left: 4px solid #ff7043; } 

        #config-panel {
            transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; opacity: 0;
            transform: translateY(-10px);
        }
        #config-panel.open {
            max-height: 1500px; opacity: 1; transform: translateY(0); padding: 16px; margin-top: 10px; margin-bottom: 10px;
        }
        
        /* BOTONES NEON ORO REALISTA */
        .race-control-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px 0; border-radius: 12px;
            background: transparent;
            border: 3px solid #ffd700;
            transition: all 0.2s ease;
            font-size: 1rem; font-weight: 900; color: #ffd700; text-transform: uppercase;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4), inset 0 0 10px rgba(255,215,0,0.1);
            font-family: Arial, sans-serif; letter-spacing: 2px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
            height: 50px;
        }
        .race-control-btn:hover:not(:disabled) {
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8), inset 0 0 15px rgba(255,215,0,0.3);
            text-shadow: 0 0 15px #ffd700;
            transform: translateY(-2px);
            border-color: #fff;
        }
        .race-control-btn:active:not(:disabled) { 
            background: #ffd700; color: #000; text-shadow: none;
            box-shadow: 0 0 40px #ffd700;
            transform: scale(0.98); 
        }
        .race-control-btn:disabled { 
            opacity: 0.3; cursor: not-allowed; border-color: #555; color: #555; text-shadow: none; box-shadow: none;
        }
        
        /* Neon Espec√≠fico para INICIAR (Oro/Verde) */
        #start-race-btn.race-control-btn { border-color: #ffd700; color: #ffd700; text-shadow: 0 0 10px #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        #start-race-btn.race-control-btn:hover:not(:disabled) { box-shadow: 0 0 30px #ffd700; background: rgba(255,215,0,0.2); border-color: #fff; color: #fff;}
        
        /* Neon Espec√≠fico para CONFIG (Oro) */
        #central-config-btn { border-color: #b8860b; color: #b8860b; text-shadow: 0 0 5px #b8860b; }
        
        /* Neon Espec√≠fico para REINICIAR (Cobre/Rojo) */
        #reset-race-btn.race-control-btn { border-color: #ff7f50; color: #ff7f50; text-shadow: 0 0 5px #ff7f50; box-shadow: 0 0 10px rgba(255, 127, 80, 0.3); }
        #reset-race-btn.race-control-btn:hover:not(:disabled) { box-shadow: 0 0 25px #ff7f50; background: rgba(255,127,80,0.1); border-color: #fff; color: #fff; }

        .control-icon { width: 18px; height: 18px; margin-right: 8px; display: inline-block; vertical-align: middle; filter: drop-shadow(0 0 2px currentColor); }
        .race-control-btn span { display: inline-flex; align-items: center; justify-content: center; width: 100%; height: 100%;}

        #lap-graph-canvas {
            width: 100%; height: 200px; background: rgba(0, 0, 0, 0.4); border-radius: 6px;
            border: 2px solid #ffd700; box-shadow: 0 0 15px rgba(255,215,0,0.2);
        }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content {
            background: linear-gradient(145deg, #fcf6ba 0%, #bf953f 100%);
            color: #2b2005; border-radius: 1.5rem;
            border: 4px solid #ffd700; box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
            max-width: 95%; max-height: 95%; overflow-y: auto; font-family: Arial, sans-serif;
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        
        table { width: 100%; text-align: left; border-collapse: collapse; margin-top: 10px; font-family: Arial, sans-serif; }
        th, td {
            padding: 8px; border-bottom: 1px solid #8b4513;
            font-family: Arial, sans-serif; font-size: 0.9rem; color: #2b2005;
        }
        th { color: #000; text-transform: uppercase; font-weight: 900; border-bottom: 3px solid #8b4513; background: rgba(255,255,255,0.3); }
        tr:hover td { background: rgba(255,255,255,0.4); }

        #record-notification {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(to right, #ffd700, #fff8e1, #ffd700);
            color: #000; padding: 1.5rem 3rem; border-radius: 2rem;
            font-size: 2rem; font-weight: 900; border: 6px solid #fff;
            box-shadow: 0 0 60px #ffd700, 0 0 20px rgba(0,0,0,0.5);
            z-index: 50; opacity: 0; pointer-events: none;
            transition: opacity 0.2s, transform 0.2s; white-space: nowrap;
            text-transform: uppercase; letter-spacing: 2px; font-family: Arial, sans-serif;
        }
        #record-notification.show { opacity: 1; transform: translate(-50%, -50%) scale(1.1); animation: pop 0.3s ease-out; }
        
        #false-start-alert {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; background: linear-gradient(to bottom, #d32f2f, #b71c1c); 
            border: 6px solid #fff; box-shadow: 0 0 50px #ff0000;
            color: #fff; text-align: center; padding: 2rem; border-radius: 1.5rem;
            z-index: 60; display: none; font-family: Arial, sans-serif;
        }
        #false-start-alert.show { display: block; animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -50%) scale(1.05); } }

        .toggle-checkbox:checked { right: 0; border-color: #8d6e63; }
        .toggle-checkbox:checked + .toggle-label { background-color: #bcaaa4; }
        
        .btn-adjust {
            background: linear-gradient(to bottom, #fff, #e0e0e0); border: 1px solid #8d6e63; color: #3e2723;
            box-shadow: 0 2px 2px rgba(0,0,0,0.1); width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: bold; font-size: 0.8rem;
        }
        .btn-adjust:active { background: #bdbdbd; box-shadow: inset 0 2px 2px rgba(0,0,0,0.1); }
        
        .calib-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); color: #ffd700; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; display: none; backdrop-filter: blur(2px); font-family: Arial, sans-serif;
        }
        .calib-overlay.active { display: flex; }
        .spinner {
            border: 6px solid #333; border-top: 6px solid #ffd700;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* TUTORIAL MODAL */
        .tut-step { background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid #b8860b; color: #333; text-align: left; }
        .tut-icon { font-size: 2rem; margin-right: 10px; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="container w-full max-w-4xl mx-auto p-4">

        <!-- HEADER -->
        <div class="gold-panel flex flex-col sm:flex-row justify-between items-center w-full py-4 px-6 mt-4 mb-6 header-flex">
            <div class="flex flex-col items-start mb-2 sm:mb-0">
                <div class="flex items-baseline">
                    <h1 class="text-4xl sm:text-5xl main-title-glow font-black tracking-widest italic mr-2">
                        KRONODUAL
                    </h1>
                    <span class="text-xl text-yellow-800 font-bold">V.5.2</span>
                </div>
                <span class="text-[10px] text-yellow-900 font-serif tracking-[0.3em] uppercase ml-1 font-bold">By Albert Closa</span>
            </div>
            
            <div class="flex items-center gap-4 mt-2 sm:mt-0">
                 <button id="history-btn" class="flex items-center text-amber-900 hover:text-black transition-colors px-3 py-1 rounded-full bg-white/30 border border-amber-500/30 hover:bg-white/60 shadow-sm group" title="Ver Historial">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history mr-2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></svg>
                    <span class="text-[10px] font-bold uppercase tracking-wider">Historial</span>
                </button>
                <button id="fullscreen-btn" class="text-amber-900 hover:text-black p-2 rounded-full bg-white/30 hover:bg-white/60 transition shadow-sm border border-amber-500/30">
                     <svg id="fs-icon-enter" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
                </button>
                
                <div id="traffic-light-module" class="traffic-light-container five-lights">
                    <div id="light-1" class="light"></div>
                    <div id="light-2" class="light"></div>
                    <div id="light-3" class="light"></div>
                    <div id="light-4" class="light"></div>
                    <div id="light-5" class="light"></div>
                </div>
            </div>
        </div>

        <!-- PANEL DE TIEMPO DIVIDIDO -->
        <div class="gold-panel w-full p-3 mb-6">
            <div class="text-center border-b-2 border-amber-800/20 pb-3 mb-3">
                <p class="text-xs text-amber-900 font-bold tracking-[0.3em] uppercase">Tiempo Global</p>
                <p id="race-time" class="text-5xl font-arial font-black text-transparent bg-clip-text bg-gradient-to-b from-black to-amber-900 drop-shadow-sm mt-1">00:00.000</p>
            </div>
            <div class="grid grid-cols-2 gap-0 divide-x-2 divide-amber-800/20">
                <div class="text-center px-2">
                    <p class="text-xs font-bold text-amber-800 tracking-widest mb-1">JUGADOR 1 (ORO)</p>
                    <p id="p1-lap-count" class="timer-value text-amber-900">V: 0 / 10</p>
                    <p id="p1-current-lap" class="text-2xl font-arial font-bold text-amber-700 mt-1 drop-shadow-sm">--.---</p>
                </div>
                <div class="text-center px-2">
                    <p class="text-xs font-bold text-orange-800 tracking-widest mb-1">JUGADOR 2 (COBRE)</p>
                    <p id="p2-lap-count" class="timer-value text-amber-900">V: 0 / 10</p>
                    <p id="p2-current-lap" class="text-2xl font-arial font-bold text-orange-700 mt-1 drop-shadow-sm">--.---</p>
                </div>
            </div>
        </div>

        <!-- CONTROL BUTTONS COMPACT -->
        <div class="w-full flex space-x-3 mb-4">
            <button id="start-race-btn" class="flex-1 race-control-btn disabled:opacity-50 disabled:cursor-not-allowed">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="control-icon"><polygon points="5 3 19 12 5 21 5 3"/></svg> INICIAR
                </span>
            </button>
            <button id="central-config-btn" class="flex-1 race-control-btn disabled:opacity-50 disabled:cursor-not-allowed">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="control-icon"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1 2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg> CONFIG
                </span>
            </button>
            <button id="reset-race-btn" class="flex-1 race-control-btn disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="control-icon"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg> REINICIAR
                </span>
            </button>
        </div>
        
        <!-- CONFIG PANEL (MOVED DOWN) -->
        <div id="config-panel" class="gold-panel w-full mb-4">
            <h2 class="text-sm neon-gold-title mb-3 border-b-2 border-amber-700/20 pb-2 flex items-center justify-start">
                <span class="mr-2">‚öôÔ∏è</span> Configuraci√≥n
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- COLUMNA JUGADOR 1 -->
                <div class="p-3 bg-yellow-100/30 rounded-xl border border-yellow-400 shadow-inner">
                    <h3 class="text-xs font-black text-amber-900 uppercase mb-2 border-b border-amber-300 pb-1 tracking-wider">JUGADOR 1 (ORO)</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] font-bold text-amber-900 mb-1">Nombre</label>
                            <input type="text" id="p1-name" value="Piloto 1" class="gold-input w-full p-1.5 rounded-lg border-l-8 border-yellow-500 text-xs" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-amber-900 mb-1">Coche</label>
                            <input type="text" id="p1-car" value="Porsche 911" class="gold-input w-full p-1.5 rounded-lg text-xs" />
                        </div>
                        <div class="bg-white/60 p-2 rounded-lg border border-amber-200 shadow-sm">
                             <div class="flex justify-between items-center mb-1">
                                <label class="text-[10px] font-bold text-amber-900">SENSIBILIDAD</label>
                                <span id="p1-threshold-disp" class="text-xs font-black text-amber-700 bg-amber-100 px-2 rounded">20</span>
                             </div>
                             <div class="flex items-center space-x-2">
                                <button class="btn-adjust" onclick="adjT(1, -5)">-</button>
                                <input type="range" id="p1-threshold" min="2" max="50" value="10" class="flex-1 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-amber-600">
                                <button class="btn-adjust" onclick="adjT(1, 5)">+</button>
                             </div>
                        </div>
                        <div>
                             <label class="block text-[10px] font-bold text-amber-900 mb-1">Sonido P1</label>
                             <select id="p1-sound" class="gold-input w-full p-1.5 rounded-lg text-xs">
                                <option value="C4">Grave (C4)</option>
                                <option value="E4">Medio (E4)</option>
                                <option value="G4">Alto (G4)</option>
                                <option value="C5" selected>Beep (C5)</option>
                                <option value="G5">Agudo (G5)</option>
                                <option value="C6">Muy Agudo (C6)</option>
                             </select>
                        </div>
                    </div>
                </div>

                <!-- COLUMNA JUGADOR 2 -->
                <div class="p-3 bg-orange-100/30 rounded-xl border border-orange-400 shadow-inner">
                    <h3 class="text-xs font-black text-orange-900 uppercase mb-2 border-b border-orange-300 pb-1 tracking-wider">JUGADOR 2 (COBRE)</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] font-bold text-amber-900 mb-1">Nombre</label>
                            <input type="text" id="p2-name" value="Piloto 2" class="gold-input w-full p-1.5 rounded-lg border-l-8 border-orange-500 text-xs" />
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-amber-900 mb-1">Coche</label>
                            <input type="text" id="p2-car" value="Audi R8" class="gold-input w-full p-1.5 rounded-lg text-xs" />
                        </div>
                        <div class="bg-white/60 p-2 rounded-lg border border-amber-200 shadow-sm">
                             <div class="flex justify-between items-center mb-1">
                                <label class="text-[10px] font-bold text-amber-900">SENSIBILIDAD</label>
                                <span id="p2-threshold-disp" class="text-xs font-black text-orange-700 bg-orange-100 px-2 rounded">20</span>
                             </div>
                             <div class="flex items-center space-x-2">
                                <button class="btn-adjust" onclick="adjT(2, -5)">-</button>
                                <input type="range" id="p2-threshold" min="2" max="50" value="10" class="flex-1 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-orange-600">
                                <button class="btn-adjust" onclick="adjT(2, 5)">+</button>
                             </div>
                        </div>
                         <div>
                             <label class="block text-[10px] font-bold text-amber-900 mb-1">Sonido P2</label>
                             <select id="p2-sound" class="gold-input w-full p-1.5 rounded-lg text-xs">
                                <option value="C4">Grave (C4)</option>
                                <option value="E4">Medio (E4)</option>
                                <option value="G4">Alto (G4)</option>
                                <option value="C5">Beep (C5)</option>
                                <option value="G5" selected>Agudo (G5)</option>
                                <option value="C6">Muy Agudo (C6)</option>
                             </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-3 border-t-2 border-amber-700/20">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                     <div>
                        <label class="block text-[10px] font-bold text-amber-800 mb-1 uppercase">Longitud Pista (m)</label>
                        <input type="number" id="track-length-input" value="15" min="1" step="0.5" class="gold-input w-full p-1.5 rounded-lg text-xs" />
                    </div>
                    <div>
                         <label class="block text-[10px] font-bold text-amber-800 mb-1 uppercase">Punto Muerto Min (s)</label>
                         <input type="number" id="min-lap-time-input" value="3.0" min="0.5" step="0.5" class="gold-input w-full p-1.5 rounded-lg text-xs" />
                     </div>
                    <div>
                        <label class="block text-[10px] font-bold text-amber-800 mb-1 uppercase">Vueltas</label>
                        <select id="lap-limit-select" class="gold-input w-full p-1.5 rounded-lg text-xs">
                            <option value="5">5 Vueltas</option>
                            <option value="10" selected>10 Vueltas</option>
                            <option value="25">25 Vueltas</option>
                            <option value="Infinity">Infinito</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between pt-4 bg-white/30 p-2 rounded-lg border border-amber-200">
                         <label for="voice-toggle" class="text-xs font-bold text-amber-900">Comentarios Voz:</label>
                         <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="voice-toggle" id="voice-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 border-amber-500 appearance-none cursor-pointer" checked/>
                            <label for="voice-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-amber-200 cursor-pointer border border-amber-500"></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- VIDEO BOX -->
        <div id="video-feed-box" class="gold-panel px-4 py-3 w-full mb-6 relative">
            <div class="flex justify-between items-center border-b-2 border-amber-800/20 pb-3 mb-3">
                <h2 class="text-base neon-gold-title">C√°mara ROI</h2>
                <div class="flex space-x-2">
                    <button id="debug-btn" class="p-2 px-4 rounded-full bg-white/30 border border-amber-500/30 hover:bg-white/60 transition shadow-lg text-amber-900 text-xs font-bold uppercase tracking-wider flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M2 12h5"/><path d="M17 12h5"/><path d="M12 2v5"/><path d="M12 17v5"/><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                        VER SENSOR
                    </button>
                    <button id="calibrate-btn" class="p-2 px-4 rounded-full bg-gradient-to-b from-amber-400 to-amber-600 text-white hover:from-amber-500 hover:to-amber-700 transition shadow-lg border border-amber-200 text-xs font-bold uppercase disabled:opacity-50 tracking-wider disabled:grayscale" disabled>
                        Calibrar Fondo
                    </button>
                    <button id="camera-on-btn" class="p-2 rounded-full bg-gradient-to-b from-green-500 to-green-700 text-white hover:from-green-600 hover:to-green-800 disabled:opacity-50 transition shadow-lg border border-green-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                    </button>
                    <button id="camera-off-btn" class="p-2 rounded-full bg-gradient-to-b from-red-500 to-red-700 text-white hover:from-red-600 hover:to-red-800 disabled:opacity-50 transition shadow-lg border border-red-300" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 2l20 20"/><path d="M4.5 17H4a2 2 0 0 1-2-2v-3h18.5"/><path d="M22 15a2 2 0 0 0-2-2h-1l-2.5-3h-2.5"/><path d="M9.5 4h5L17 7h3a2 2 0 0 1 2 2v1"/><path d="M14.5 17a3 3 0 1 1-5.6-2.5"/></svg>
                    </button>
                </div>
            </div>
            
            <div id="camera-error-alert" class="hidden bg-red-100 border border-red-400 text-red-700 py-3 rounded-md mb-3">
                <span id="camera-error-text" class="block sm:inline font-bold text-sm"></span>
            </div>
            
            <!-- OVERLAYS SOBRE EL VIDEO -->
            <div id="video-container" class="rounded-xl border-4 border-yellow-400/50 relative">
                <video id="webcam-feed" class="w-full shadow-inner" autoplay playsinline></video>
                <canvas id="debug-canvas" class="debug-canvas"></canvas>
                
                <!-- ALERT DE CALIBRACION -->
                <div id="calib-overlay" class="calib-overlay">
                    <div class="spinner"></div>
                    <h3 id="calib-step-title" class="text-2xl font-black text-yellow-300 uppercase tracking-widest drop-shadow-md">Calibrando Sensores</h3>
                    <p id="calib-step-desc" class="text-base mt-2 text-white font-bold bg-black/50 px-4 py-1 rounded-full">Mant√©n la pista despejada</p>
                </div>

                <!-- ALERT DE SALIDA NULA -->
                <div id="false-start-alert">
                    <h2 class="text-5xl font-black uppercase tracking-widest mb-4 text-white drop-shadow-md">¬°SALIDA NULA!</h2>
                    <p id="false-start-player" class="text-3xl font-bold text-yellow-300 bg-black/40 inline-block px-6 py-2 rounded-lg"></p>
                </div>

                <!-- ROI PLAYER 1 (AZUL) -->
                <div id="roi-p1" class="movable-rectangle" style="top: 25%; left: 10%;">
                    <div class="roi-label">P1</div>
                    <div id="msg-p1" class="test-msg"></div>
                    <div id="val-p1" class="detection-val">0%</div>
                    <div class="signal-bar-container"><div id="bar-p1" class="signal-bar"></div></div>
                    <div class="resize-handle handle-tl"></div>
                    <div class="resize-handle handle-br"></div>
                </div>
                <!-- ROI PLAYER 2 (ROJO) -->
                <div id="roi-p2" class="movable-rectangle" style="top: 25%; left: 60%;">
                    <div class="roi-label">P2</div>
                    <div id="msg-p2" class="test-msg"></div>
                    <div id="val-p2" class="detection-val">0%</div>
                     <div class="signal-bar-container"><div id="bar-p2" class="signal-bar"></div></div>
                    <div class="resize-handle handle-tl"></div>
                    <div class="resize-handle handle-br"></div>
                </div>
            </div>
            
            <canvas id="video-canvas" class="hidden"></canvas>
            <div id="video-status" class="text-center text-xs mt-3 text-amber-900 font-bold tracking-widest uppercase">Inicia la c√°mara para configurar carriles</div>
        </div>

        <!-- TELEMETRIA TWIN -->
        <div class="gold-panel w-full p-4 mb-6">
            <h2 class="text-sm neon-gold-title mb-3 border-b-2 border-amber-800/20 pb-2 flex items-center justify-start text-yellow-600">
                TELEMETR√çA EN VIVO
            </h2>
            <div class="telemetry-grid-twin">
                <!-- COLUMNA P1 -->
                <div class="telemetry-col">
                    <div class="telemetry-item bg-p1-soft">
                        <p class="telemetry-label text-amber-800">MEJOR VUELTA</p>
                        <p id="p1-best-lap" class="telemetry-data font-arial text-lg">--.---</p>
                    </div>
                    <div class="telemetry-item">
                        <p class="telemetry-label">√öLTIMA</p>
                        <p id="p1-last-lap" class="telemetry-data font-arial">--.---</p>
                    </div>
                    <div class="telemetry-item">
                        <p class="telemetry-label">MEDIA</p>
                        <p id="p1-avg-time" class="telemetry-data font-arial">--.---</p>
                    </div>
                    <div class="telemetry-item">
                        <p class="telemetry-label">VELOCIDAD</p>
                        <p id="p1-avg-speed" class="telemetry-data font-arial">--.- Km/h</p>
                    </div>
                    <div class="telemetry-item">
                         <p class="telemetry-label">GAP</p>
                         <p id="p1-gap" class="telemetry-data font-arial text-amber-900">--</p>
                    </div>
                </div>

                <!-- COLUMNA P2 -->
                <div class="telemetry-col">
                    <div class="telemetry-item bg-p2-soft">
                        <p class="telemetry-label text-orange-800">MEJOR VUELTA</p>
                        <p id="p2-best-lap" class="telemetry-data font-arial text-lg">--.---</p>
                    </div>
                    <div class="telemetry-item">
                        <p class="telemetry-label">√öLTIMA</p>
                        <p id="p2-last-lap" class="telemetry-data font-arial">--.---</p>
                    </div>
                    <div class="telemetry-item">
                        <p class="telemetry-label">MEDIA</p>
                        <p id="p2-avg-time" class="telemetry-data font-arial">--.---</p>
                    </div>
                    <div class="telemetry-item">
                        <p class="telemetry-label">VELOCIDAD</p>
                        <p id="p2-avg-speed" class="telemetry-data font-arial">--.- Km/h</p>
                    </div>
                    <div class="telemetry-item">
                         <p class="telemetry-label">GAP</p>
                         <p id="p2-gap" class="telemetry-data font-arial text-amber-900">--</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRAFICA -->
        <div class="gold-panel w-full p-4 mb-4">
            <h2 class="text-xs neon-gold-title mb-3 border-b border-yellow-900/50 pb-2 uppercase tracking-widest text-left text-yellow-600">Tiempos de Carrera</h2>
            <canvas id="lap-graph-canvas"></canvas>
        </div>
    </div>

    <!-- TUTORIAL MODAL (NUEVO) -->
    <div id="tutorialModal" class="modal-overlay">
        <div class="modal-content p-8 w-full max-w-lg neon-border-box text-center">
            <div class="mb-6 border-b-2 border-amber-300 pb-4">
                <h3 class="text-3xl font-black text-amber-950 uppercase">Gu√≠a R√°pida</h3>
                <p class="text-amber-800 font-bold text-sm">Configuraci√≥n en 3 pasos</p>
            </div>
            
            <div class="text-left space-y-4 mb-8">
                <div class="tut-step">
                    <span class="tut-icon">üì±</span>
                    <strong>1. C√ÅMARA FIJA:</strong> Enfoca la pista. Importante: ¬°Que no se mueva!
                </div>
                <div class="tut-step">
                    <span class="tut-icon">üéØ</span>
                    <strong>2. SENSORES:</strong> Arrastra los cuadrados sobre los carriles.
                </div>
                <div class="tut-step">
                    <span class="tut-icon">‚ú®</span>
                    <strong>3. CALIBRAR:</strong> Con la pista <b>VAC√çA</b>, pulsa "Calibrar Fondo".
                </div>
                <div class="tut-step">
                    <span class="tut-icon">üèéÔ∏è</span>
                    <strong>4. LISTO:</strong> Ajusta la sensibilidad hasta que marque 0% en reposo.
                </div>
            </div>

            <button id="close-tutorial-btn" class="w-full bg-gradient-to-r from-amber-600 to-amber-800 text-white font-bold py-4 rounded-xl hover:from-amber-500 hover:to-amber-700 transition shadow-xl border border-amber-400/50 text-lg tracking-widest uppercase">
                ¬°ENTENDIDO, A CORRER!
            </button>
        </div>
    </div>

    <!-- MODAL HISTORIAL -->
    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal-content p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center border-b-2 border-amber-800/30 pb-3 mb-4">
                <h3 class="text-2xl font-black text-amber-900 uppercase tracking-wide">Historial de Carreras</h3>
                <button id="close-history-btn" class="text-amber-800 hover:text-black font-bold text-xl px-2">X</button>
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="w-full text-left text-sm">
                    <thead><tr><th class="p-3">FECHA</th><th class="p-3">GANADOR</th><th class="p-3">TIEMPO</th><th class="p-3">P1 BEST</th><th class="p-3">P2 BEST</th></tr></thead>
                    <tbody id="full-history-body" class="text-amber-950 font-medium"></tbody>
                </table>
                <p id="no-history-msg" class="text-center text-amber-800 mt-6 font-bold hidden">No hay registros guardados.</p>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="clear-history-btn" class="text-xs bg-red-100 text-red-800 border border-red-300 px-4 py-2 rounded-lg hover:bg-red-200 font-bold uppercase tracking-wider transition">Borrar Todo</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL RESULTADOS -->
    <div id="resultsModal" class="modal-overlay hidden">
        <div class="modal-content p-8 w-full max-w-2xl neon-border-box text-center">
             <div class="mb-8">
                <h3 class="text-4xl font-black text-amber-950 uppercase tracking-widest mb-2" style="text-shadow: 0 2px 0 rgba(255,255,255,0.5)">¬°Carrera Finalizada!</h3>
                <div class="inline-block bg-white/50 px-6 py-2 rounded-full border border-amber-300 shadow-sm mt-2">
                    <p id="winner-text" class="text-2xl font-bold text-green-800">Ganador: ...</p>
                </div>
            </div>
            
            <!-- GRID DE DETALLES -->
            <div class="grid grid-cols-2 gap-6 mb-8 text-left">
                <!-- P1 Summary -->
                <div class="bg-yellow-100/50 p-4 rounded-xl border border-yellow-400 shadow-inner">
                    <h4 class="text-xl text-amber-900 font-black mb-3 text-center border-b-2 border-amber-300 pb-2" id="modal-p1-name">P1</h4>
                    <div class="space-y-2 text-sm text-amber-900">
                        <div class="flex justify-between"><span>Total:</span> <span id="modal-p1-total" class="font-bold font-arial">--</span></div>
                        <div class="flex justify-between"><span>Mejor:</span> <span id="modal-p1-best" class="font-bold text-green-700 font-arial">--</span></div>
                        <div class="flex justify-between"><span>Media:</span> <span id="modal-p1-avg" class="font-bold font-arial">--</span></div>
                        <div class="flex justify-between"><span>Vel. Med:</span> <span id="modal-p1-speed" class="font-bold font-arial">--</span></div>
                    </div>
                    <div class="mt-4">
                        <p class="text-xs font-bold text-amber-800 mb-1 uppercase tracking-wide">Vueltas:</p>
                        <ul id="modal-p1-laps" class="text-xs font-arial h-40 overflow-y-auto bg-white/80 p-2 rounded-lg border border-amber-200 shadow-inner text-amber-900"></ul>
                    </div>
                </div>

                <!-- P2 Summary -->
                <div class="bg-orange-100/50 p-4 rounded-xl border border-orange-400 shadow-inner">
                    <h4 class="text-xl text-orange-900 font-black mb-3 text-center border-b-2 border-orange-300 pb-2" id="modal-p2-name">P2</h4>
                    <div class="space-y-2 text-sm text-orange-900">
                        <div class="flex justify-between"><span>Total:</span> <span id="modal-p2-total" class="font-bold font-arial">--</span></div>
                        <div class="flex justify-between"><span>Mejor:</span> <span id="modal-p2-best" class="font-bold text-green-700 font-arial">--</span></div>
                         <div class="flex justify-between"><span>Media:</span> <span id="modal-p2-avg" class="font-bold font-arial">--</span></div>
                         <div class="flex justify-between"><span>Vel. Med:</span> <span id="modal-p2-speed" class="font-bold font-arial">--</span></div>
                    </div>
                    <div class="mt-4">
                        <p class="text-xs font-bold text-orange-800 mb-1 uppercase tracking-wide">Vueltas:</p>
                        <ul id="modal-p2-laps" class="text-xs font-arial h-40 overflow-y-auto bg-white/80 p-2 rounded-lg border border-orange-200 shadow-inner text-orange-900"></ul>
                    </div>
                </div>
            </div>

            <!-- BOTONES ACCI√ìN MODAL -->
            <button id="export-excel-btn" class="w-full bg-gradient-to-r from-emerald-600 to-emerald-900 text-white font-bold py-3 rounded-xl hover:from-emerald-500 hover:to-emerald-800 transition shadow-xl border border-emerald-400/50 text-base tracking-widest uppercase mb-4 flex items-center justify-center gap-2 font-arial">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                EXPORTAR DATOS (CSV)
            </button>

            <button id="modal-restart-btn" class="w-full bg-gradient-to-r from-gray-800 to-black text-white font-bold py-4 rounded-xl hover:from-gray-700 hover:to-gray-900 transition shadow-xl border border-amber-500/50 text-lg tracking-widest uppercase font-arial">VOLVER A EMPEZAR</button>
        </div>
    </div>
    
    <!-- NOTIFICACION DE RECORD -->
    <div id="record-notification">¬°NUEVO R√âCORD!</div>

    <script>
        // --- VARIABLES ---
        const videoElement = document.getElementById('webcam-feed');
        const videoContainer = document.getElementById('video-container');
        const canvas = document.getElementById('video-canvas');
        const debugCanvas = document.getElementById('debug-canvas');
        const debugBtn = document.getElementById('debug-btn');
        let isDebugMode = false;
        
        // UI Elements
        const startRaceBtn = document.getElementById('start-race-btn');
        const resetRaceBtn = document.getElementById('reset-race-btn');
        const configPanel = document.getElementById('config-panel');
        const centralConfigBtn = document.getElementById('central-config-btn');
        const calibrateBtn = document.getElementById('calibrate-btn');
        const calibOverlay = document.getElementById('calib-overlay');
        const calibStepTitle = document.getElementById('calib-step-title');
        const calibStepDesc = document.getElementById('calib-step-desc');
        
        const trackLengthInput = document.getElementById('track-length-input');
        const lapLimitSelect = document.getElementById('lap-limit-select');
        const minLapTimeInput = document.getElementById('min-lap-time-input'); 
        const voiceToggle = document.getElementById('voice-toggle');
        const recordNotification = document.getElementById('record-notification');
        const cameraOnBtn = document.getElementById('camera-on-btn');
        const cameraOffBtn = document.getElementById('camera-off-btn');
        const videoStatus = document.getElementById('video-status');
        const falseStartAlert = document.getElementById('false-start-alert');
        const falseStartPlayerName = document.getElementById('false-start-player');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        
        // Tutorial
        const tutorialModal = document.getElementById('tutorialModal');
        const closeTutorialBtn = document.getElementById('close-tutorial-btn');
        
        // Audio
        const synth = new Tone.Synth().toDestination();
        const polySynth = new Tone.PolySynth(Tone.Synth).toDestination();

        // Estado
        let cameraStream = null;
        let isProcessing = false;
        let isRaceActive = false;
        let isDetectionReady = false;
        let isCountdown = false;
        let raceAborted = false;
        let isCalibrating = false;
        let raceStartTime = 0;
        let raceIntervalId = null;
        let totalLapsTarget = 10;
        
        const players = [
            {
                id: 1,
                nameId: 'p1-name', carId: 'p1-car',
                roiId: 'roi-p1', valId: 'val-p1', msgId: 'msg-p1', barId: 'bar-p1',
                lapCountId: 'p1-lap-count', currentLapId: 'p1-current-lap',
                bestLapId: 'p1-best-lap', lastLapId: 'p1-last-lap', avgSpeedId: 'p1-avg-speed',
                avgTimeId: 'p1-avg-time', gapId: 'p1-gap',
                thresholdId: 'p1-threshold', thresholdDispId: 'p1-threshold-disp',
                soundId: 'p1-sound',
                
                // State for game
                laps: 0, lapHistory: [], bestLap: Infinity, lapStartTime: 0, lastRecordTime: 0,
                totalTime: 0, isBlocked: false, finished: false,
                hasCrossedStart: false, 
                currentMinLapTime: 3000,
                
                // --- GRID-LOCK CORE STATE (V5.0) ---
                sensitivity: 10, // Percentage of changed pixels
                refData: null, // The "Empty Track" snapshot
                
                soundTone: "C5",
                activeFrames: 0,
                isPermanentlyBlocked: false
            },
            {
                id: 2,
                nameId: 'p2-name', carId: 'p2-car',
                roiId: 'roi-p2', valId: 'val-p2', msgId: 'msg-p2', barId: 'bar-p2',
                lapCountId: 'p2-lap-count', currentLapId: 'p2-current-lap',
                bestLapId: 'p2-best-lap', lastLapId: 'p2-last-lap', avgSpeedId: 'p2-avg-speed',
                avgTimeId: 'p2-avg-time', gapId: 'p2-gap',
                thresholdId: 'p2-threshold', thresholdDispId: 'p2-threshold-disp',
                soundId: 'p2-sound',
                
                // State for game
                laps: 0, lapHistory: [], bestLap: Infinity, lapStartTime: 0, lastRecordTime: 0,
                totalTime: 0, isBlocked: false, finished: false,
                hasCrossedStart: false,
                currentMinLapTime: 3000,
                
                // --- GRID-LOCK CORE STATE (V5.0) ---
                sensitivity: 10,
                refData: null,
                
                soundTone: "G5",
                activeFrames: 0,
                isPermanentlyBlocked: false
            }
        ];

        // --- SPEECH HELPER ---
        function speak(text, rate = 1.0, force = false) {
            if (!voiceToggle.checked) return;
            if (force) window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = "es-ES"; msg.rate = rate;
            window.speechSynthesis.speak(msg);
        }

        // --- HELPER: ADJUST SENSITIVITY ---
        window.adjT = function(pId, delta) {
            const p = players[pId-1];
            let val = parseInt(document.getElementById(p.thresholdId).value);
            val = Math.max(2, Math.min(50, val + delta));
            document.getElementById(p.thresholdId).value = val;
            updateThreshold(pId);
        }

        function updateThreshold(pId) {
            const p = players[pId-1];
            const val = document.getElementById(p.thresholdId).value;
            p.sensitivity = parseInt(val);
            document.getElementById(p.thresholdDispId).textContent = val;
        }

        // --- CAMERA ---
        async function startWebcam() {
            if (cameraStream) return;
            videoStatus.textContent = 'INICIANDO...';
            try {
                const constraints = { 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 }
                    } 
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints)
                    .catch(() => navigator.mediaDevices.getUserMedia({ video: true }));

                videoElement.srcObject = cameraStream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    debugCanvas.width = videoElement.videoWidth;
                    debugCanvas.height = videoElement.videoHeight;
                    isProcessing = true;
                    processVideo();
                    document.querySelectorAll('.movable-rectangle').forEach(el => el.style.display = 'block');
                    videoStatus.textContent = 'C√ÅMARA ACTIVA - SISTEMA LISTO';
                    videoStatus.className = "text-center text-sm mt-2 text-green-600 font-bold uppercase";
                    cameraOnBtn.disabled = true;
                    cameraOffBtn.disabled = false;
                    calibrateBtn.disabled = false;
                };
            } catch (err) {
                videoStatus.textContent = 'Error: ' + err.name;
                videoStatus.className = "text-center text-sm mt-2 text-red-600";
            }
        }

        function stopWebcam() {
            if (cameraStream) cameraStream.getTracks().forEach(t => t.stop());
            cameraStream = null; isProcessing = false; videoElement.srcObject = null;
            document.querySelectorAll('.movable-rectangle').forEach(el => el.style.display = 'none');
            cameraOnBtn.disabled = false; cameraOffBtn.disabled = true;
            calibrateBtn.disabled = true;
            videoStatus.textContent = 'C√°mara apagada.'; videoStatus.className = "text-amber-900 text-center text-sm mt-2";
        }

        // --- CORE: GRID-LOCK PIXEL DIFFERENCE (V.5.0) ---
        // Extracts raw pixel data for a specific ROI
        function getRoiPixels(roi) {
            const vw = videoElement.videoWidth; const vh = videoElement.videoHeight;
            if (!vw || !vh) return null;
            
            const rect = roi.getBoundingClientRect();
            const parentRect = videoContainer.getBoundingClientRect();
            
            const relX = (rect.left - parentRect.left) / parentRect.width;
            const relY = (rect.top - parentRect.top) / parentRect.height;
            const relW = rect.width / parentRect.width;
            const relH = rect.height / parentRect.height;
            
            const x = Math.floor(Math.max(0, relX * vw));
            const y = Math.floor(Math.max(0, relY * vh));
            const w = Math.ceil(Math.min(vw - x, relW * vw));
            const h = Math.ceil(Math.min(vh - y, relH * vh));
            
            if (w <= 0 || h <= 0) return null;

            const ctx = canvas.getContext('2d', {willReadFrequently:true});
            ctx.drawImage(videoElement, x, y, w, h, 0, 0, w, h);
            
            return {
                data: ctx.getImageData(0,0,w,h).data,
                x: x, y: y, w: w, h: h
            };
        }

        function processVideo() {
            if (!isProcessing) return;
            
            const p1 = players[0];
            const p2 = players[1];
            const roi1 = document.getElementById(p1.roiId);
            const roi2 = document.getElementById(p2.roiId);
            
            const snap1 = getRoiPixels(roi1);
            const snap2 = getRoiPixels(roi2);
            
            if (!snap1 || !snap2) { requestAnimationFrame(processVideo); return; }

            // Auto-Initialize Reference if missing (First Frame or Reset)
            if (!p1.refData) p1.refData = new Uint8ClampedArray(snap1.data);
            if (!p2.refData) p2.refData = new Uint8ClampedArray(snap2.data);
            
            // Re-Initialize if dimensions change (User resized ROI)
            if (p1.refData.length !== snap1.data.length) p1.refData = new Uint8ClampedArray(snap1.data);
            if (p2.refData.length !== snap2.data.length) p2.refData = new Uint8ClampedArray(snap2.data);

            // --- DETECCION ---
            const dCtx = debugCanvas.getContext('2d');
            if (isDebugMode) dCtx.clearRect(0, 0, debugCanvas.width, debugCanvas.height);

            // Calculate Difference
            let score1 = calculateDifference(snap1, p1.refData, p1.sensitivity, isDebugMode ? dCtx : null);
            let score2 = calculateDifference(snap2, p2.refData, p2.sensitivity, isDebugMode ? dCtx : null);
            
            // --- V.5.1 ANTI-GHOST PROTOCOL (CROSS-TALK SUPPRESSION) ---
            // If both lanes show activity, but one is vastly stronger, suppress the weaker one.
            // This kills light reflections from the other car's headlights.
            if (score1 > 0 && score2 > 0) {
                // If P1 is > 2.5x stronger than P2, assume P2 is just a reflection of P1
                if (score1 > score2 * 2.5) {
                    score2 = 0; 
                } 
                // Vice-versa
                else if (score2 > score1 * 2.5) {
                    score1 = 0;
                }
            }

            document.getElementById(p1.valId).textContent = score1.toFixed(0) + "%";
            document.getElementById(p2.valId).textContent = score2.toFixed(0) + "%";
            
            document.getElementById(p1.barId).style.width = Math.min(100, score1 * 2) + '%';
            document.getElementById(p2.barId).style.width = Math.min(100, score2 * 2) + '%';

            let crossed1 = score1 > p1.sensitivity;
            let crossed2 = score2 > p2.sensitivity;

            const now = Date.now();
            
            [p1, p2].forEach((p, idx) => {
                const roi = document.getElementById(p.roiId);
                const crossed = (idx === 0) ? crossed1 : crossed2;
                
                // WATCHDOG (Hand Rejection)
                if (crossed && !isCalibrating) {
                    p.activeFrames++;
                    if (p.activeFrames > 45) { // 1.5s blocked
                        p.isPermanentlyBlocked = true;
                        roi.classList.add('roi-blocked');
                        document.getElementById(p.msgId).textContent = "BLOQUEADO";
                    }
                } else {
                    p.activeFrames = 0;
                    p.isPermanentlyBlocked = false;
                    roi.classList.remove('roi-blocked');
                }
                
                const validTrigger = crossed && !p.isPermanentlyBlocked;

                if (validTrigger) roi.classList.add('roi-detected');
                else roi.classList.remove('roi-detected');
                
                const inDeadTime = (now - p.lastRecordTime < p.currentMinLapTime) && isRaceActive && p.hasCrossedStart;
                if (inDeadTime) roi.classList.add('roi-dead');
                else roi.classList.remove('roi-dead');

                if (!isCalibrating) {
                    if (!isRaceActive && !isCountdown && validTrigger) {
                         document.getElementById(p.msgId).textContent = "TEST";
                    } else if (!isRaceActive && !p.isPermanentlyBlocked) {
                         document.getElementById(p.msgId).textContent = "";
                    }

                    if (isCountdown && !raceAborted) {
                         if (validTrigger && !p.isBlocked) {
                             handleFalseStart(p);
                             p.isBlocked = true;
                         }
                    }
                    else if (isRaceActive && isDetectionReady && !p.finished) {
                        if (validTrigger && !p.isBlocked) {
                            if (inDeadTime) return; 
                            p.isBlocked = true;
                            if (!p.hasCrossedStart) {
                                p.hasCrossedStart = true;
                                p.lapStartTime = now; 
                                p.lastRecordTime = now; 
                                synth.triggerAttackRelease(p.soundTone, "0.1");
                                document.getElementById(p.msgId).textContent = "GO!";
                            } else {
                                document.getElementById(p.msgId).textContent = "OK";
                                recordLap(p);
                            }
                        } else if (!crossed && p.isBlocked) {
                            p.isBlocked = false;
                            if(isRaceActive) setTimeout(() => document.getElementById(p.msgId).textContent = "", 500);
                        }
                    }
                    if (!crossed && p.isBlocked && !isCountdown) p.isBlocked = false;
                }
            });
            
            requestAnimationFrame(processVideo);
        }
        
        // --- CORE ALGORITHM: NOISE-GATED PIXEL COUNT ---
        function calculateDifference(current, ref, sens, ctx) {
            const data = current.data;
            let changedPixels = 0;
            let totalPixels = data.length / 4;
            // V5.1: INCREASED NOISE FLOOR TO REJECT HEADLIGHTS
            const NOISE_FLOOR = 80; 
            
            if (ctx) {
                var imgData = ctx.createImageData(current.w, current.h);
                var debugData = imgData.data;
            }

            for (let i = 0; i < data.length; i += 4) { // Stride 1 for accuracy on small cars
                // Simple Euclidean Distance per pixel channel
                const diff = Math.abs(data[i] - ref[i]) + 
                             Math.abs(data[i+1] - ref[i+1]) + 
                             Math.abs(data[i+2] - ref[i+2]);
                
                if (diff > NOISE_FLOOR) {
                    changedPixels++;
                    if (ctx) {
                        debugData[i] = 255; debugData[i+1] = 255; debugData[i+2] = 255; debugData[i+3] = 255; 
                    }
                } else {
                    if (ctx) debugData[i+3] = 0; // Transparent
                }
            }
            
            if (ctx) ctx.putImageData(imgData, current.x, current.y);

            return (changedPixels / totalPixels) * 100;
        }
        
        // --- CALIBRATION: JUST SNAPSHOT THE EMPTY TRACK ---
        async function runAutoCalibration() {
            if (!isProcessing) return;
            isCalibrating = true;
            calibOverlay.classList.add('active');
            calibStepTitle.textContent = "CAPTURA FONDO";
            calibStepDesc.textContent = "No muevas nada.";
            
            speak("Capturando fondo.", 1.0, true);
            await new Promise(r => setTimeout(r, 1000));
            
            // TAKE SNAPSHOT
            const s1 = getRoiPixels(document.getElementById('roi-p1'));
            const s2 = getRoiPixels(document.getElementById('roi-p2'));
            
            if (s1) players[0].refData = new Uint8ClampedArray(s1.data);
            if (s2) players[1].refData = new Uint8ClampedArray(s2.data);
            
            calibStepTitle.textContent = "¬°LISTO!";
            calibStepDesc.textContent = `Referencia guardada.`;
            polySynth.triggerAttackRelease(["E5", "A5"], "0.3");
            
            speak("Listo.", 1.0, true);
            await new Promise(r => setTimeout(r, 1000));
            isCalibrating = false;
            calibOverlay.classList.remove('active');
        }

        function handleFalseStart(player) {
            raceAborted = true;
            isCountdown = false;
            polySynth.triggerAttackRelease(["C2", "F#2", "C3"], "1");
            const pName = document.getElementById(player.nameId).value;
            falseStartPlayerName.textContent = pName;
            falseStartAlert.classList.add('show');
            speak("Salida Nula. " + pName + " adelantado.", 1.1, true);
            resetRaceBtn.disabled = false;
            document.querySelectorAll('.light').forEach(l => l.className = "light");
        }

        function formatTime(ms) {
            if (ms === Infinity || ms <= 0) return "--.---";
            const min = Math.floor(ms/60000);
            const sec = Math.floor((ms%60000)/1000);
            const mil = Math.floor(ms%1000);
            return `${min>0?min+':':''}${String(sec).padStart(2,'0')}.${String(mil).padStart(3,'0')}`;
        }

        function startRace() {
            configPanel.classList.remove('open');
            startRaceBtn.disabled = true; resetRaceBtn.disabled = true;
            falseStartAlert.classList.remove('show');
            totalLapsTarget = lapLimitSelect.value==='Infinity'?Infinity:parseInt(lapLimitSelect.value);
            const configMinLap = parseFloat(minLapTimeInput.value) * 1000;
            
            players.forEach(p => {
                p.soundTone = document.getElementById(p.soundId).value;
                p.laps=0; p.lapHistory=[]; p.bestLap=Infinity; p.totalTime=0; p.lastRecordTime=0; 
                p.finished=false; p.isBlocked=false; p.hasCrossedStart=false; 
                p.currentMinLapTime = configMinLap; p.activeFrames = 0; p.isPermanentlyBlocked = false;
                updatePlayerUI(p);
                document.getElementById(p.currentLapId).textContent = "ESPERANDO...";
                document.getElementById(p.avgTimeId).textContent = "--.---";
                document.getElementById(p.gapId).textContent = "--";
            });
            document.getElementById('race-time').textContent = "00:00.000";
            drawGraph();

            const lights = [1,2,3,4,5].map(i=>document.getElementById('light-'+i));
            lights.forEach(l=>l.className="light");

            (async()=>{
                isCountdown = true; raceAborted = false;
                speak("Pilotos listos.", 1.0, true);
                const safeSleep = (ms) => new Promise(r => setTimeout(r, ms));
                for(let i=0;i<5;i++){ 
                     if(raceAborted) return; 
                     if (i < lights.length) {
                        lights[i].classList.add('red'); 
                        synth.triggerAttackRelease("C4","0.1");
                     }
                     await safeSleep(1000);
                     if(raceAborted) return; 
                }
                await safeSleep(Math.random()*1500+500);
                if(raceAborted) return;
                isCountdown = false;
                lights.forEach(l=>{l.classList.remove('red'); l.classList.add('green');});
                polySynth.triggerAttackRelease(["C5","G5"],"0.5");
                isRaceActive=true; isDetectionReady=true; resetRaceBtn.disabled=false;
                raceStartTime=Date.now();
                players.forEach(p=>p.lapStartTime=raceStartTime);
                startTimers();
            })();
        }

        function startTimers() {
            if(raceIntervalId) clearInterval(raceIntervalId);
            raceIntervalId = setInterval(()=>{
                const now = Date.now();
                document.getElementById('race-time').textContent = formatTime(now - raceStartTime);
                players.forEach(p => {
                    if(!p.finished && p.hasCrossedStart) {
                        const elap = now - p.lapStartTime;
                        const sec = Math.floor(elap/1000);
                        const ms = String(elap%1000).padStart(3,'0');
                        document.getElementById(p.currentLapId).textContent = `${sec}.${ms}`;
                    }
                });
                updateGaps();
            }, 40);
        }

        function recordLap(p) {
            const now = Date.now();
            if (now - p.lastRecordTime < p.currentMinLapTime) return; 
            p.lastRecordTime = now;
            const lapTime = now - p.lapStartTime;
            p.lapHistory.push(lapTime);
            p.laps++;
            p.lapStartTime = now;
            
            if (p.lapHistory.length >= 2) {
                 const total = p.lapHistory.reduce((a,b)=>a+b,0);
                 const avg = total / p.lapHistory.length;
                 p.currentMinLapTime = avg * 0.5;
            }
            
            let isNewRecord = false;
            if (lapTime < p.bestLap) {
                p.bestLap = lapTime;
                showNotification(`R√âCORD P${p.id}!`);
                isNewRecord = true;
            }

            synth.triggerAttackRelease(p.soundTone, "0.1");
            updatePlayerUI(p);
            
            const name = document.getElementById(p.nameId).value;
            if (isNewRecord) {
                const lapTimeSec = (lapTime/1000).toFixed(2);
                speak(`R√©cord ${name}, ${lapTimeSec}`);
            }

            if(totalLapsTarget !== Infinity) {
                const remaining = totalLapsTarget - p.laps;
                if(remaining === 5) speak(`√öltimas 5 vueltas, ${name}.`, 1.1, true);
                if(remaining === 1) speak(`¬°√öltima vuelta, ${name}!`);
            }

            if(totalLapsTarget!==Infinity && p.laps>=totalLapsTarget) {
                p.finished = true;
                p.totalTime = now - raceStartTime;
                document.getElementById(p.lapCountId).textContent = "FIN";
                document.getElementById(p.currentLapId).textContent = "META";
                polySynth.triggerAttackRelease(["E6"], "0.2");
                if (players.every(pl=>pl.finished)) endRace();
            }
            drawGraph();
        }

        function updatePlayerUI(p) {
            document.getElementById(p.lapCountId).textContent = `V: ${p.laps} / ${totalLapsTarget===Infinity?'‚àû':totalLapsTarget}`;
            document.getElementById(p.bestLapId).textContent = formatTime(p.bestLap);
            const last = p.lapHistory.length>0 ? p.lapHistory[p.lapHistory.length-1] : 0;
            document.getElementById(p.lastLapId).textContent = formatTime(last);
            if(p.laps>0) {
                const tot = p.lapHistory.reduce((a,b)=>a+b,0);
                const avg = tot/p.laps;
                const len = parseFloat(trackLengthInput.value);
                const spd = (len/(avg/1000))*3.6;
                document.getElementById(p.avgSpeedId).textContent = spd.toFixed(1) + " Km/h";
                document.getElementById(p.avgTimeId).textContent = formatTime(avg);
            }
        }
        
        function updateGaps() {
             const now = Date.now();
             const t1 = players[0].finished ? players[0].totalTime : (players[0].laps > 0 ? (players[0].lapHistory.reduce((a,b)=>a+b,0) + (now - players[0].lapStartTime)) : 0);
             const t2 = players[1].finished ? players[1].totalTime : (players[1].laps > 0 ? (players[1].lapHistory.reduce((a,b)=>a+b,0) + (now - players[1].lapStartTime)) : 0);
             if (players[0].laps > 0 && players[1].laps > 0) {
                 const diff = t1 - t2;
                 const diffSec = (Math.abs(diff)/1000).toFixed(1);
                 if (diff < 0) {
                     document.getElementById(players[0].gapId).textContent = "LIDER";
                     document.getElementById(players[0].gapId).className = "telemetry-data font-arial text-green-700";
                     document.getElementById(players[1].gapId).textContent = "+" + diffSec;
                     document.getElementById(players[1].gapId).className = "telemetry-data font-arial text-red-700";
                 } else {
                     document.getElementById(players[1].gapId).textContent = "LIDER";
                     document.getElementById(players[1].gapId).className = "telemetry-data font-arial text-green-700";
                     document.getElementById(players[0].gapId).textContent = "+" + diffSec;
                     document.getElementById(players[0].gapId).className = "telemetry-data font-arial text-red-700";
                 }
             }
        }

        function endRace() {
            isRaceActive = false; clearInterval(raceIntervalId);
            const p1 = players[0]; const p2 = players[1];
            let winner = null;
            if (p1.finished && p2.finished) winner = p1.totalTime < p2.totalTime ? p1 : p2;
            else if (p1.finished) winner = p1; else if (p2.finished) winner = p2;
            else winner = p1.laps > p2.laps ? p1 : p2;

            const wName = document.getElementById(winner.nameId).value;
            const wTime = winner.totalTime;
            document.getElementById('winner-text').textContent = `Ganador: ${wName}`;
            speak("Victoria de " + wName, 1.0, true);
            
            players.forEach(p => {
                const n = document.getElementById(p.nameId).value;
                const totalT = p.finished ? p.totalTime : (p.lapHistory.reduce((a,b)=>a+b,0)); 
                const lapCount = p.lapHistory.length;
                const avgT = lapCount > 0 ? totalT / lapCount : 0;
                const trackLen = parseFloat(trackLengthInput.value);
                const avgSpd = avgT > 0 ? (trackLen / (avgT/1000)) * 3.6 : 0;

                document.getElementById(`modal-p${p.id}-name`).textContent = n + (p===winner?" üëë":"");
                document.getElementById(`modal-p${p.id}-total`).textContent = formatTime(totalT);
                document.getElementById(`modal-p${p.id}-best`).textContent = formatTime(p.bestLap);
                document.getElementById(`modal-p${p.id}-avg`).textContent = formatTime(avgT);
                document.getElementById(`modal-p${p.id}-speed`).textContent = avgSpd.toFixed(1) + " km/h";

                const ul = document.getElementById(`modal-p${p.id}-laps`);
                ul.innerHTML = "";
                p.lapHistory.forEach((lap, idx) => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between border-b border-gray-100 last:border-0 py-1 font-arial";
                    const isBest = (lap === p.bestLap && p.bestLap !== Infinity); 
                    li.innerHTML = `<span>V${idx+1}</span> <span class="${isBest ? 'text-green-700 font-bold' : ''}">${formatTime(lap)}</span>`;
                    ul.appendChild(li);
                });
            });
            saveHistory(wName, wTime);
            document.getElementById('resultsModal').classList.remove('hidden');
            setTimeout(()=>document.getElementById('resultsModal').classList.add('open'),10);
        }

        function exportToExcel() {
            const date = new Date().toLocaleString();
            const winnerText = document.getElementById('winner-text').textContent;
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "KRONODUAL V.2.0 - REPORTE DE CARRERA\n\n";
            csvContent += `Fecha:,${date}\n`;
            csvContent += `${winnerText}\n\n`;
            players.forEach(p => {
                const name = document.getElementById(p.nameId).value;
                const car = document.getElementById(p.carId).value;
                const totalTime = document.getElementById(`modal-p${p.id}-total`).textContent;
                const bestLap = document.getElementById(`modal-p${p.id}-best`).textContent;
                const avgSpeed = document.getElementById(`modal-p${p.id}-speed`).textContent;
                
                csvContent += `PILOTO ${p.id} (${p.id===1?'ORO':'COBRE'}),${name.toUpperCase()}\n`;
                csvContent += `Coche:,${car}\n`;
                csvContent += `Tiempo Total:,${totalTime}\n`;
                csvContent += `Mejor Vuelta:,${bestLap}\n`;
                csvContent += `Velocidad Media:,${avgSpeed}\n`;
                csvContent += "VUELTA,TIEMPO\n";
                
                p.lapHistory.forEach((lap, index) => {
                    csvContent += `${index + 1},${formatTime(lap)}\n`;
                });
                csvContent += "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `krono_race_${Date.now()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function drawGraph() {
            const ctx = document.getElementById('lap-graph-canvas').getContext('2d');
            const w = ctx.canvas.parentElement.offsetWidth;
            ctx.canvas.width = w; ctx.canvas.height = 200;
            const p1d = players[0].lapHistory; const p2d = players[1].lapHistory;
            const maxL = Math.max(p1d.length, p2d.length);
            
            ctx.clearRect(0,0,w,200);
            ctx.fillStyle = '#aaa'; ctx.font = '10px Arial';
            ctx.fillText("TIEMPO (s)", 5, 10);
            
            if(maxL===0) return;

            const all = [...p1d, ...p2d];
            const maxT = Math.max(...all);
            const pad = 30; const gh = 160; const gw = w - pad*2;
            const bw = (gw / maxL) * 0.4;
            
            ctx.shadowBlur = 10;
            for(let i=0; i<maxL; i++) {
                const x = pad + i * (gw/maxL) + 10;
                if(p1d[i]) {
                    const h = (p1d[i]/maxT)*gh;
                    ctx.fillStyle = '#ffd700'; ctx.shadowColor = '#ffd700'; 
                    ctx.fillRect(x, 180-h, bw, h);
                }
                if(p2d[i]) {
                    const h = (p2d[i]/maxT)*gh;
                    ctx.fillStyle = '#b87333'; ctx.shadowColor = '#b87333';
                    ctx.fillRect(x+bw, 180-h, bw, h);
                }
                ctx.shadowBlur = 0;
                ctx.fillStyle='#aaa'; ctx.font='10px Arial'; ctx.textAlign='center';
                ctx.fillText(i+1, x+bw, 195);
            }
        }
        
        function showNotification(txt) {
            recordNotification.textContent = txt; recordNotification.classList.add('show');
            setTimeout(()=>recordNotification.classList.remove('show'),2000);
        }

        function saveHistory(winner, winnerTimeMs) {
            let finalTime = "--.---";
            if (winnerTimeMs) finalTime = formatTime(winnerTimeMs);
            else {
                 const pObj = players.find(p => document.getElementById(p.nameId).value === winner);
                 if (pObj) finalTime = formatTime(pObj.totalTime);
            }
            const rec = {
                date: new Date().toLocaleString(),
                winner: winner,
                time: finalTime,
                p1Best: formatTime(players[0].bestLap),
                p2Best: formatTime(players[1].bestLap)
            };
            let hist = JSON.parse(localStorage.getItem('krono_twin_hist') || '[]');
            hist.unshift(rec);
            localStorage.setItem('krono_twin_hist', JSON.stringify(hist.slice(0, 50)));
        }

        function loadHistory() {
            const hist = JSON.parse(localStorage.getItem('krono_twin_hist') || '[]');
            const tbody = document.getElementById('full-history-body');
            tbody.innerHTML = '';
            if (hist.length === 0) {
                document.getElementById('no-history-msg').classList.remove('hidden');
            } else {
                document.getElementById('no-history-msg').classList.add('hidden');
                hist.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-amber-200 hover:bg-amber-100/50";
                    tr.innerHTML = `<td class="p-2 text-xs">${r.date}</td><td class="p-2 font-bold text-green-800">${r.winner}</td><td class="p-2 font-arial">${r.time}</td><td class="p-2 text-blue-800 text-xs">${r.p1Best}</td><td class="p-2 text-red-800 text-xs">${r.p2Best}</td>`;
                    tbody.appendChild(tr);
                });
            }
            const m = document.getElementById('historyModal');
            m.classList.remove('hidden'); setTimeout(()=>m.classList.add('open'),10);
        }

        document.getElementById('history-btn').onclick = loadHistory;
        document.getElementById('close-history-btn').onclick = () => {
             const m = document.getElementById('historyModal'); m.classList.remove('open');
             setTimeout(()=>m.classList.add('hidden'),300);
        };
        document.getElementById('clear-history-btn').onclick = () => {
            localStorage.removeItem('krono_twin_hist'); loadHistory();
        };
        document.getElementById('modal-restart-btn').onclick = () => {
            document.getElementById('resultsModal').classList.remove('open');
            setTimeout(()=>document.getElementById('resultsModal').classList.add('hidden'),300);
            document.getElementById('race-time').textContent = "00:00.000";
            isRaceActive=false; clearInterval(raceIntervalId); startRaceBtn.disabled=false;
        };
        
        // --- DEBUG MODE TOGGLE ---
        debugBtn.onclick = () => {
            isDebugMode = !isDebugMode;
            document.body.classList.toggle('debug-mode');
            if (isDebugMode) {
                debugBtn.classList.add('bg-red-500', 'text-white');
                debugBtn.classList.remove('bg-white/30');
            } else {
                debugBtn.classList.remove('bg-red-500', 'text-white');
                debugBtn.classList.add('bg-white/30');
                const dCtx = debugCanvas.getContext('2d');
                dCtx.clearRect(0, 0, debugCanvas.width, debugCanvas.height);
            }
        };

        calibrateBtn.onclick = runAutoCalibration;
        exportExcelBtn.onclick = exportToExcel;
        
        closeTutorialBtn.onclick = () => {
            tutorialModal.classList.remove('open');
            polySynth.triggerAttackRelease(["C5", "E5"], "0.3");
        };

        // --- DRAG AND RESIZE LOGIC ---
        let actRoi = null; let isDrag = false; let isResize = false; let resizeHandle = null; 
        let startX = 0, startY = 0; let startLeft = 0, startTop = 0, startWidth = 0, startHeight = 0;

        function getEventPos(e) { return e.touches ? e.touches[0] : e; }

        function dragStart(e) {
            const handle = e.target.closest('.resize-handle');
            const roi = e.target.closest('.movable-rectangle');
            if (!roi) return;
            if (e.cancelable && !e.target.closest('input') && !e.target.closest('select')) e.preventDefault();
            const pos = getEventPos(e);
            startX = pos.clientX; startY = pos.clientY;
            startLeft = roi.offsetLeft; startTop = roi.offsetTop;
            startWidth = roi.offsetWidth; startHeight = roi.offsetHeight;
            actRoi = roi;
            if (handle) {
                isResize = true;
                resizeHandle = handle.classList.contains('handle-tl') ? 'tl' : 'br';
                e.stopPropagation();
            } else { isDrag = true; }
        }

        function dragMove(e) {
            if (!isDrag && !isResize) return;
            e.preventDefault();
            const pos = getEventPos(e);
            const dx = pos.clientX - startX; const dy = pos.clientY - startY;
            const parentRect = videoContainer.getBoundingClientRect();
            if (isDrag) {
                let newLeft = startLeft + dx; let newTop = startTop + dy;
                actRoi.style.left = (newLeft / parentRect.width) * 100 + '%';
                actRoi.style.top = (newTop / parentRect.height) * 100 + '%';
            } else if (isResize) {
                if (resizeHandle === 'br') {
                    let newW = Math.max(30, startWidth + dx); let newH = Math.max(30, startHeight + dy);
                    actRoi.style.width = (newW / parentRect.width) * 100 + '%';
                    actRoi.style.height = (newH / parentRect.height) * 100 + '%';
                } else if (resizeHandle === 'tl') {
                    let newW = startWidth - dx; let newH = startHeight - dy;
                    let newL = startLeft + dx; let newT = startTop + dy;
                    if (newW > 30) { actRoi.style.width = (newW/parentRect.width)*100+'%'; actRoi.style.left = (newL/parentRect.width)*100+'%'; }
                    if (newH > 30) { actRoi.style.height = (newH/parentRect.height)*100+'%'; actRoi.style.top = (newT/parentRect.height)*100+'%'; }
                }
            }
        }

        function dragEnd() { isDrag = false; isResize = false; actRoi = null; }

        videoContainer.addEventListener('mousedown', dragStart);
        videoContainer.addEventListener('touchstart', dragStart, {passive: false});
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('touchmove', dragMove, {passive: false});
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchend', dragEnd);

        document.getElementById('p1-threshold').addEventListener('input', ()=>updateThreshold(1));
        document.getElementById('p2-threshold').addEventListener('input', ()=>updateThreshold(2));
        startRaceBtn.onclick = startRace;
        resetRaceBtn.onclick = () => { 
            window.speechSynthesis.cancel();
            raceAborted = true; 
            isCountdown = false;
            isRaceActive = false; 
            clearInterval(raceIntervalId); 
            document.querySelectorAll('.light').forEach(l => l.className = "light");
            startRaceBtn.disabled = false; 
            falseStartAlert.classList.remove('show'); 
        };
        centralConfigBtn.onclick = () => configPanel.classList.toggle('open');
        cameraOnBtn.onclick = startWebcam; cameraOffBtn.onclick = stopWebcam;
        document.getElementById('fullscreen-btn').onclick = () => !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen();
        
        function previewSound(tone) {
            if(Tone.context.state !== 'running') {
                Tone.start().then(() => { synth.triggerAttackRelease(tone, "0.1"); });
            } else { synth.triggerAttackRelease(tone, "0.1"); }
        }

        document.getElementById('p1-sound').addEventListener('change', (e) => previewSound(e.target.value));
        document.getElementById('p2-sound').addEventListener('change', (e) => previewSound(e.target.value));

        window.onload = () => {
             updateThreshold(1); updateThreshold(2);
             startWebcam();
             setTimeout(() => { tutorialModal.classList.add('open'); }, 500);
        };
    </script>
</body>
</html>
